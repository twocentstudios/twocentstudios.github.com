<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>A Deep Dive Into iOS Messages Extensions</title>

  <meta property="og:type" content="article" />
  <meta property="og:title" content="A Deep Dive Into iOS Messages Extensions" />
  <meta property="og:url" content="https://twocentstudios.com/2016/06/24/a-deep-dive-into-ios-messages-extensions/" />
  
    <meta property="og:article:published_time" content="2016-06-24T20:39:29-05:00" />
  
  

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="A Deep Dive Into iOS Messages Extensions" />
  

  <link href='https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;350;400;600' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://twocentstudios.com/2016/06/24/a-deep-dive-into-ios-messages-extensions/">
  <link rel="alternate" type="application/rss+xml" title="twocentstudios" href="https://twocentstudios.com/feed.xml" />
</head>

  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NE82N02W8S"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NE82N02W8S');
</script>

  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">twocentstudios</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
          <a class="page-link" href="/blog/">Blog</a>
          
        
          
        
          
          <a class="page-link" href="/hire-me/">Hire Me</a>
          
        
          
        
          
          <a class="page-link" href="/portfolio/">Portfolio</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">A Deep Dive Into iOS Messages Extensions</h1>
    <p class="post-meta">Jun 24, 2016</p>
  </header>

  <article class="post-content">
    <p>Apple announced Messages Extensions as part of iOS 10 allowing third-party apps to integrate directly with the iMessage platform. This integration follows Facebook Messenger and pretty much every other major messaging platform in the US and abroad.</p>

<p>In this post I’ll present an overview of Messages Extensions, walk through a simple example extension to illustrate some key features, and finally explore some advanced features of Messages.framework. Some of this information is gleaned directly from the WWDC talk and some is from poking around in the beta. Hopefully this will save you some time in having to kick the tires yourself. Sticker packs are pretty straightforward, so I won’t be covering those.</p>

<p>I recommend watching the WWDC talk <a href="https://developer.apple.com/videos/play/wwdc2016/224/">iMessage Apps and Stickers Part 2</a> and reviewing the code for <a href="https://developer.apple.com/library/prerelease/content/samplecode/IceCreamBuilder">IceCreamBuilder</a>, the Apple endorsed example for this topic. I consider that talk the primary source of information on Messages.framework. Here’s a link to the <a href="https://developer.apple.com/reference/messages">Messages.framework</a> docs.</p>

<p>Note: This post was originally written for iOS 10 beta1. It was partially updated for beta2 on 7/7/2016.</p>

<h2 id="overview">Overview</h2>

<h3 id="app-extension">App Extension</h3>

<p>Messages Extensions follow the App Extension target format introduced in iOS 8. Other examples include Today Extensions, custom keyboards, and Share Extensions. As an App Extension, it is bound by special rules outlined in the <a href="https://developer.apple.com/library/ios/documentation/General/Conceptual/ExtensibilityPG/ExtensionOverview.html#//apple_ref/doc/uid/TP40014214-CH2-SW2">App Extension Programming Guide</a></p>

<h3 id="backwards-compatibility">Backwards Compatibility</h3>

<p>Messages Extensions allow the creation and modification of a standardized encapsulated model/view pair <code class="language-plaintext highlighter-rouge">MSMessage</code>. Two of the main design points Apple needed to address in their implementation of Messages Extensions were:</p>

<ol>
  <li>User A creates a custom message using an extension. What happens if User B receiving a specially created message does not have the extension installed that was used to create the message?</li>
  <li>User A creates a custom message using an extension. What happens if User B is on a previous version of iOS?</li>
</ol>

<p>The answer to these was:</p>

<ol>
  <li>Use a standardized template layout (view model) preconfigured by the extension that requires no additional third-party code execution to display as intended. Use the principle of progressive enhancement to provide a richer interface for viewing/modifying messages.</li>
  <li>Require model data to be encoded as a URL which allows fallback to a web browser.</li>
</ol>

<h3 id="core-ideas">Core Ideas</h3>

<p>At their core, Messages Extensions:</p>

<ul>
  <li>provide the specification of a model and template view model (contained within an <code class="language-plaintext highlighter-rouge">MSMessage</code> instance).</li>
  <li>provide a rich interface to view, create, and manipulate these models (an <code class="language-plaintext highlighter-rouge">MSMessagesAppViewController</code> subclass).</li>
</ul>

<p>Defining these bits further:</p>

<ul>
  <li>The <strong>model</strong> is a URL (<code class="language-plaintext highlighter-rouge">MSMessage.url</code>). It is arguably designed to be very interoperable in the case that all parties do not have an extension installed.</li>
  <li>The <strong>template view model</strong> is a special framework-provided template object (<code class="language-plaintext highlighter-rouge">MSMessageTemplateLayout</code>). It is minimally configurable and designed to be a summary view of your content.</li>
  <li>The <strong>rich interface</strong> is a fully customizable <code class="language-plaintext highlighter-rouge">UIView</code> (<code class="language-plaintext highlighter-rouge">MSMessagesAppViewController</code>). This custom view can display a more domain appropriate representation of the model and allow creation and modification of the model.</li>
</ul>

<h3 id="user-interface-points">User Interface Points</h3>

<p>Message Extensions have three basic interface points for Messages.app users:</p>

<p><strong>Message summary display</strong>: all users running iOS 10+ and macOS Sierra+ will see a template view of a message created by an extension regardless of whether or not they have that specific extension installed. Users on previous versions will only receive the message’s summary text and URL as two separate messages, but only if the URL has an http/https scheme.</p>

<div class="caption-wrapper"><img class="caption" src="/images/messages-layout-template.png" width="" height="" alt="MSMessageTemplateLayout (courtesy of WWDC)." title="MSMessageTemplateLayout (courtesy of WWDC)." /><div class="caption-text">MSMessageTemplateLayout (courtesy of WWDC).</div></div>

<p><strong>Message creation</strong>: the initial creation of a message occurs in the compact view of your extension. By tapping the App Store logo to the left of the message text field, the keyboard is replaced by a paging scroll view containing all the installed Messages Extensions. Extensions in compact mode have a keyboard-sized viewport to display any content they wish. Users have the option to tap the disclosure button on the right side of the screen at any time to expand this view to full screen or recollapse it later.</p>

<div class="caption-wrapper"><img class="caption" src="/images/messages-collapsed-view-small.png" width="" height="" alt="The collapsed view of our example extension." title="The collapsed view of our example extension." /><div class="caption-text">The collapsed view of our example extension.</div></div>

<p><strong>Message viewing &amp; modification</strong>: for users who have your extension installed, tapping an existing message sent by another user or one they created will launch your extension into an expanded (full screen) viewport. Your extension receives the contents of the tapped message in order to configure itself for display and/or editing. For users that do not have your extension installed, a web browser will be opened with the message’s URL (on compatible OS versions assuming an http/https schema).</p>

<div class="caption-wrapper"><img class="caption" src="/images/messages-expanded-view-small.png" width="" height="" alt="One state of the expanded view of our example extension." title="One state of the expanded view of our example extension." /><div class="caption-text">One state of the expanded view of our example extension.</div></div>

<h3 id="model-strategies">Model Strategies</h3>

<p>There are two primary strategies for designing your app extension’s model layer. The example extension presented later will be a standalone extension.</p>

<h4 id="standalone-extensions">Standalone Extensions</h4>

<p>If you’re creating a standalone extension that exists only within the walls of Messages.app, you will have to encode all model data shared between conversation participants in <code class="language-plaintext highlighter-rouge">MSMessage</code>’s <code class="language-plaintext highlighter-rouge">url</code> field. Your extension itself will essentially be stateless or hold state that is only relevant to the current user (e.g. IceCreamBuilder saves the user’s previously created stickers in <code class="language-plaintext highlighter-rouge">NSUserDefaults</code>).</p>

<div class="language-plaintext highlighter-rouge"><pre class="highlight"><code>?type=translation&amp;question=What%20time%20is%20it?&amp;answer=今何時ですか。
</code></pre>
</div>

<p>Although this strategy is simpler, the downside is that there is more opportunity for human-scale race conditions to occur, especially if the conversation has more than two participants. This scenario is discussed at the end of the WWDC session. For example, if two participants modify the same message at once, the latest message sent will “win” and overwrite the data.</p>

<h3 id="webservice-extensions">Webservice Extensions</h3>

<p>If you’re creating an extension to an existing webservice, you have the ability to use your servers to share state between participants. Instead of encoding all state into the <code class="language-plaintext highlighter-rouge">MSMessage</code>’s <code class="language-plaintext highlighter-rouge">url</code> field, you could provide a link to a resource and fetch it from the server as necessary via <code class="language-plaintext highlighter-rouge">NSURLSession</code>.</p>

<div class="language-plaintext highlighter-rouge"><pre class="highlight"><code>https://example.com/items/742932
</code></pre>
</div>

<p>Apple recommends this approach in the WWDC session (albeit somewhat casually, simply referencing “the cloud”), specifically mentioning the avoidance of race conditions.</p>

<p>Keep security in mind though. If your app is creating harmless, ephemeral resources, it may be acceptable to use the participant UUIDs provided by <code class="language-plaintext highlighter-rouge">MSConversation</code> as security tokens. These would not work for long term resources, as reinstalling your extension will regenerate the local participant UUID. You could also use <code class="language-plaintext highlighter-rouge">NSUserDefaults</code> to share your service’s auth token for the user logged into your primary app. This technique is beyond the scope of this post, but see the <a href="https://developer.apple.com/library/ios/documentation/General/Conceptual/ExtensibilityPG/ExtensionScenarios.html#//apple_ref/doc/uid/TP40014214-CH21-SW1">App Extension Programming Guide</a> for more information.</p>

<h2 id="example-extension-walkthrough">Example Extension Walkthrough</h2>

<p>That’s enough background for now. Let’s dive into the example extension’s implementation.</p>

<p>The whole project is on <a href="https://github.com/twocentstudios/Messages-Translator-Extension">Github</a> if you’d like to skip straight to the source.</p>

<p>I’ll be using iOS 10 beta1, Swift 3 beta, Xcode 8 beta.</p>

<h3 id="what-were-building">What We’re Building</h3>

<p>I’m currently learning Japanese. When I’m chatting with my Japanese friends (usually in LINE), it can be difficult asking for corrections of my attempts at writing Japanese. Usually my friends can work out my meaning, but don’t bother correcting me since it’s awkward to do so without a dedicated interface. The conversation usually goes off track if I try to ask them to correct me or we just go back to speaking English.</p>

<p>It would be cool to have collaborative interface for corrections/translations in an iMessage chat, so we’re going to build it! Most of the inspiration comes from the HelloTalk app. HelloTalk provides dedicated messaging platform and tools for language learners. Here’s an example:</p>

<div class="caption-wrapper"><img class="caption" src="/images/messages-hello-talk-small.png" width="" height="" alt="The HelloTalk interface for corrections and translations, respectively." title="The HelloTalk interface for corrections and translations, respectively." /><div class="caption-text">The HelloTalk interface for corrections and translations, respectively.</div></div>

<p>Not only are we going to build an interface for corrections, but since the concept is similar, we’ll also build an option for asking for translations.</p>

<p>Here’s an example correction request flow in our extension (<a href="/images/messages-correction.mov">View the screen capture 5.3MB</a>):</p>

<blockquote>
  <p>Chris: [correction request] 週末、東京<strong>で</strong>行きましたか。
Miu: [correction] 週末、東京<strong>に</strong>行きましたか。
Miu: [continuing conversation] はい、東京に行きました！</p>
</blockquote>

<div class="caption-wrapper"><img class="caption" src="/images/messages-correction-flow-small.png" width="" height="" alt="The correction flow of our example app." title="The correction flow of our example app." /><div class="caption-text">The correction flow of our example app.</div></div>

<p>Here’s an example translation request flow in our extension:</p>

<blockquote>
  <p>Chris: [translation request] Did you go to Tokyo last weekend?
Miu: [translation] 週末、東京に行きましたか。</p>
</blockquote>

<div class="caption-wrapper"><img class="caption" src="/images/messages-translation-flow-small.png" width="" height="" alt="The translation flow of our example app." title="The translation flow of our example app." /><div class="caption-text">The translation flow of our example app.</div></div>

<p>Our extension won’t have all the bells and whistles of HelloTalk, but hopefully it will show you the basics of creating your own Messages extension.</p>

<h3 id="high-level-data-flow">High Level Data Flow</h3>

<p>I like modeling applications as a series of data transformations and side effects. Let’s take a step back and understand how data will flow through our extension.</p>

<p>The most straightforward flow will be a user tapping on an existing message created by our extension so let’s start there.</p>

<p>Defining some of our terms:</p>

<ul>
  <li><strong>URL</strong>: Data is stored in the <code class="language-plaintext highlighter-rouge">url</code> parameter of an <code class="language-plaintext highlighter-rouge">MSMessage</code>. Everything we need to restore the state of our message must be contained in the <code class="language-plaintext highlighter-rouge">url</code> string.</li>
  <li><strong>Model</strong>: This is our domain model, an enum we’ll call <code class="language-plaintext highlighter-rouge">Pair</code> (referring to a question/answer pair) that contains <code class="language-plaintext highlighter-rouge">Translation</code> or <code class="language-plaintext highlighter-rouge">Correction</code> structs. All value types.</li>
  <li><strong>ViewState</strong>: Another enum that describes each possible state our view can be in. It can be converted directly from any Pair.</li>
  <li><strong>View</strong>: Our extension only has one <code class="language-plaintext highlighter-rouge">UIView</code> which is configured directly from a <code class="language-plaintext highlighter-rouge">ViewState</code> value.</li>
  <li><strong>ViewAction</strong>: The View communicates well specified actions to its delegate.</li>
  <li><strong>MSMessageTemplateLayout</strong>: This is basically another ViewState/ViewModel object provided by Messages.Framework and configured by us.</li>
</ul>

<p>Below is the entire transformation flow:</p>

<div class="language-plaintext highlighter-rouge"><pre class="highlight"><code>MSConversation -&gt; 
MSMessage -&gt; 
URL -&gt; 
Model -&gt; 
ViewState -&gt; 
View -&gt; 
ViewAction + Model -&gt; 
Model -&gt; 
URL + MSMessageTemplateLayout -&gt; 
MSMessage + MSSession -&gt; 
MSConversation
</code></pre>
</div>

<p>Broken down:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">MSConversation -&gt; MSMessage -&gt; URL</code>: We’ll access the <code class="language-plaintext highlighter-rouge">url</code> property on the <code class="language-plaintext highlighter-rouge">MSMessage</code> instance on the <code class="language-plaintext highlighter-rouge">MSConversation</code> instance provided by Messages. <code class="language-plaintext highlighter-rouge">conversation.selectedMessage.url</code> if you will.</li>
  <li><code class="language-plaintext highlighter-rouge">URL -&gt; Model</code>: Our Model’s properties will have been previously encoded (by us) into <code class="language-plaintext highlighter-rouge">URLQueryItem</code>s. We’ll need a function to decode them.</li>
  <li><code class="language-plaintext highlighter-rouge">Model -&gt; ViewState</code>: Any Model value must be able to be shown to the user.</li>
  <li><code class="language-plaintext highlighter-rouge">ViewState -&gt; View</code>: Setting the <code class="language-plaintext highlighter-rouge">viewState</code> property on our view will configure the view by adding data to text fields, showing/hiding subviews, and changing labels.</li>
  <li><code class="language-plaintext highlighter-rouge">View -&gt; ViewAction</code>: We’ll encode button taps and text field data into an enum of actions and pass the enum to the View’s delegate. Our View won’t have to know anything about how to transform these actions into a new Model or ViewState.</li>
  <li><code class="language-plaintext highlighter-rouge">ViewAction + Model -&gt; Model</code>: We need to combine an action with the old model to create a new model that includes the user’s changes.</li>
  <li><code class="language-plaintext highlighter-rouge">Model -&gt; URL + MSMessageTemplateLayout</code>: Finally, we need to convert our model back to the the fields required to configure a new message.</li>
  <li><code class="language-plaintext highlighter-rouge">URL + MSMessageTemplateLayout -&gt; MSMessage + MSSession -&gt; MSConversation</code>: We’ll configure a new message, attaching an <code class="language-plaintext highlighter-rouge">MSSession</code> provided by Messages, then call <code class="language-plaintext highlighter-rouge">insertMessage</code> on the conversation.</li>
</ul>

<p>That may seem like a lot of transformations, but in reality they’re all simple ~10-20 line pure functions that cover all the possible enum cases.</p>

<p>We’ll go into some of these transformations in more detail later on.</p>

<h3 id="data-models">Data Models</h3>

<p>We’re going to support both a correction type and a translation type. They’re pretty similar, just a field for a question and a field for an answer. However:</p>

<ul>
  <li>The correction type might already be correct, so there needs to be a state for that.</li>
  <li>The corrector might not know what the requester is asking and thus can’t correct it.</li>
  <li>For the translation type, the translator may not know how to translate the request so there should also be a state for that.</li>
</ul>

<h4 id="domain-model">Domain Model</h4>

<p>We’re going to go a little enum crazy because in my opinion that’s one of the coolest features of Swift.</p>

<p><code class="language-plaintext highlighter-rouge">Pair</code> represents a question/answer pair. It can be either a translation or a correction.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">enum</span> <span class="kt">Pair</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nf">translation</span><span class="p">(</span><span class="kt">Translation</span><span class="p">)</span>
    <span class="k">case</span> <span class="nf">correction</span><span class="p">(</span><span class="kt">Correction</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Our <code class="language-plaintext highlighter-rouge">Translation</code> type will have a question and an answer. We have two types of answer though, so we’ll make another enum (<code class="language-plaintext highlighter-rouge">TranslationAnswer</code>) for that.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">Translation</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">question</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">answer</span><span class="p">:</span> <span class="kt">TranslationAnswer</span><span class="p">?</span>    
<span class="p">}</span>

<span class="kd">enum</span> <span class="kt">TranslationAnswer</span><span class="p">:</span> <span class="kt">RawRepresentable</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nf">known</span><span class="p">(</span><span class="kt">String</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">unknown</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The <code class="language-plaintext highlighter-rouge">Correction</code> type looks pretty similar. Just one more <code class="language-plaintext highlighter-rouge">CorrectionAnswer</code> case.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">Correction</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">question</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">answer</span><span class="p">:</span> <span class="kt">CorrectionAnswer</span><span class="p">?</span>    
<span class="p">}</span>

<span class="kd">enum</span> <span class="kt">CorrectionAnswer</span><span class="p">:</span> <span class="kt">RawRepresentable</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">correct</span>
    <span class="k">case</span> <span class="nf">incorrect</span><span class="p">(</span><span class="kt">String</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">unknown</span>
<span class="p">}</span>
</code></pre>
</div>

<blockquote>
  <p>Another valid interpretation would have been to condense <code class="language-plaintext highlighter-rouge">Correction</code> and <code class="language-plaintext highlighter-rouge">CorrectionAnswer</code> into a single enum instead of using nullable properties. We’re doing some of this transformation work in the <code class="language-plaintext highlighter-rouge">ViewState</code> instead.</p>
</blockquote>

<h4 id="messages-framework-model">Messages Framework Model</h4>

<p>In order to do the <code class="language-plaintext highlighter-rouge">URL -&gt; Model</code> and <code class="language-plaintext highlighter-rouge">Model -&gt; URL</code> transformations, we’ll need to devise an encoding scheme for our Model. There are a number of ways to do this, but we’ll go with the simplest method.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Pair</code> (our top level enum) will encode its case as a <code class="language-plaintext highlighter-rouge">type</code> param. (e.g. <code class="language-plaintext highlighter-rouge">type=translation</code> or <code class="language-plaintext highlighter-rouge">type=correction</code>).</li>
  <li><code class="language-plaintext highlighter-rouge">TransformationAnswer</code> and <code class="language-plaintext highlighter-rouge">CorrectionAnswer</code> will be conformed to the <code class="language-plaintext highlighter-rouge">RawRepresentable</code> protocol and converted to a single string field.</li>
  <li><code class="language-plaintext highlighter-rouge">Pair</code>, <code class="language-plaintext highlighter-rouge">Transformation</code>, <code class="language-plaintext highlighter-rouge">Correction</code> will expose a <code class="language-plaintext highlighter-rouge">queryItems</code> property for the <code class="language-plaintext highlighter-rouge">Model -&gt; URL</code> transformation. They will expose a custom nilable initializer receiving an array of <code class="language-plaintext highlighter-rouge">[URLQueryItem]</code>.</li>
</ul>

<p>At the end of the day, the URL will look something like this:</p>

<div class="language-plaintext highlighter-rouge"><pre class="highlight"><code>?type=translation&amp;question=What%20time%20is%20it?&amp;answer=今何時ですか。
</code></pre>
</div>

<p>Unfortunately, it’s still pretty boilerplatey. Check out the <a href="https://github.com/twocentstudios/Messages-Translator-Extension/blob/master/MessagesExtension/URLQueryItem.swift">source</a> for the implementation details.</p>

<p>Other implementations could convert object graphs to a single JSON string first (URL encoded of course) and store this encoded string as a single <code class="language-plaintext highlighter-rouge">URLQueryItem</code>.</p>

<h3 id="view-models">View Models</h3>

<h4 id="viewstate">ViewState</h4>

<p>We have 10 possible view states.</p>

<ul>
  <li>1 introductory state.</li>
  <li>2 intermediate steps for each <code class="language-plaintext highlighter-rouge">Pair</code> type.</li>
  <li>3 end states for a <code class="language-plaintext highlighter-rouge">Translation</code>.</li>
  <li>2 end states for a <code class="language-plaintext highlighter-rouge">Correction</code>.</li>
</ul>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">enum</span> <span class="kt">ViewState</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">promptNew</span>
    <span class="k">case</span> <span class="n">translationNew</span>
    <span class="k">case</span> <span class="nf">translationPart</span><span class="p">(</span><span class="nv">question</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="k">case</span> <span class="nf">translationCompleteUnknown</span><span class="p">(</span><span class="nv">question</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="k">case</span> <span class="nf">translationCompleteKnown</span><span class="p">(</span><span class="nv">question</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">answer</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">correctionNew</span>
    <span class="k">case</span> <span class="nf">correctionPart</span><span class="p">(</span><span class="nv">question</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="k">case</span> <span class="nf">correctionCompleteIncorrect</span><span class="p">(</span><span class="nv">question</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">answer</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="k">case</span> <span class="nf">correctionCompleteUnknown</span><span class="p">(</span><span class="nv">question</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="k">case</span> <span class="nf">correctionCompleteCorrect</span><span class="p">(</span><span class="nv">question</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p>With any case, we have enough information to completely lay out our interface.</p>

<p>See the implementation of the <code class="language-plaintext highlighter-rouge">Model -&gt; ViewState</code> transformation <a href="https://github.com/twocentstudios/Messages-Translator-Extension/blob/master/MessagesExtension/ViewState.swift">here</a>.</p>

<p>Although in this case it would be possible to do a <code class="language-plaintext highlighter-rouge">ViewState -&gt; Model</code> transformation, this type of transformation can be inherently lossy. We’ll use a <code class="language-plaintext highlighter-rouge">ViewAction + Model -&gt; Model</code> transformation instead to process changes.</p>

<h4 id="viewaction">ViewAction</h4>

<p>As discussed a earlier, we’ll be using another enum to succinctly communicate user actions from the View layer back to the Controller layer. The intention behind this is to keep any domain logic and transformations out of the View layer and present a strict interface between our application’s layers defined by value types.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">enum</span> <span class="kt">ViewAction</span> <span class="p">{</span>   
    <span class="k">case</span> <span class="n">createNewTranslation</span>
    <span class="k">case</span> <span class="n">createNewCorrection</span>
    <span class="k">case</span> <span class="nf">addTranslation</span><span class="p">(</span><span class="nv">question</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="k">case</span> <span class="nf">completeTranslationKnown</span><span class="p">(</span><span class="nv">answer</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">completeTranslationUnknown</span>
    <span class="k">case</span> <span class="nf">addCorrection</span><span class="p">(</span><span class="nv">question</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="k">case</span> <span class="nf">completeCorrectionIncorrect</span><span class="p">(</span><span class="nv">answer</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">completeCorrectionCorrect</span>
    <span class="k">case</span> <span class="n">completeCorrectionUnknown</span>
<span class="p">}</span>
</code></pre>
</div>

<h4 id="msmessagetemplatelayout--messagetemplatelayout">MSMessageTemplateLayout &amp; MessageTemplateLayout</h4>

<p><code class="language-plaintext highlighter-rouge">MSMessageTemplateLayout</code> is Messages.app’s generic view format for inline messages. It serves the same purpose of our ViewState. (<code class="language-plaintext highlighter-rouge">MSMessageTemplateLayout</code> is currently the sole subclass of the <code class="language-plaintext highlighter-rouge">MSMessageLayout</code> base class, which could allow Apple to provide other message layouts in the future.)</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="c1">// Messages.framework</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="kt">MSMessageTemplateLayout</span> <span class="p">:</span> <span class="kt">MSMessageLayout</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">caption</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">subcaption</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">trailingCaption</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">trailingSubcaption</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">image</span><span class="p">:</span> <span class="kt">UIImage</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">mediaFileURL</span><span class="p">:</span> <span class="kt">URL</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">imageTitle</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">imageSubtitle</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
<span class="p">}</span>
</code></pre>
</div>

<blockquote>
  <p>I’m a little disappointed that the text is <code class="language-plaintext highlighter-rouge">String</code> and not <code class="language-plaintext highlighter-rouge">AttributedString</code>, but I can see why Apple might want to keep customization to a minimum up front.</p>
</blockquote>

<p>We’ll only be using the caption and subcaptions so we’ll make a helper struct to decouple our implementation from Messages. It’s a bit pedantic to do so, but oh well.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">MessageTemplateLayout</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">caption</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">subcaption</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">trailingCaption</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">trailingSubcaption</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Although we could do the transformation as <code class="language-plaintext highlighter-rouge">Pair -&gt;  MessageTemplateLayout</code>, I think it makes our lives easier to convert from <code class="language-plaintext highlighter-rouge">ViewState -&gt;  MessageTemplateLayout</code> instead.</p>

<h3 id="view">View</h3>

<p>I usually don’t use Storyboards, but for this occasion I decided to do so.</p>

<p><code class="language-plaintext highlighter-rouge">MessagesView</code> is our custom view. It has a couple text fields, a bunch of labels, and a bunch of buttons. All of these subviews are shared amongst our various <code class="language-plaintext highlighter-rouge">ViewState</code>s and their actions and data are translated back to something our Controller understands.</p>

<p>There’s a huge function that converts <code class="language-plaintext highlighter-rouge">ViewState -&gt; View</code> by setting label text, hidden attributes, and button titles for each state.</p>

<p><code class="language-plaintext highlighter-rouge">@IBAction -&gt; ViewAction</code> happens in each tap handler before being provided to the view’s delegate.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">MessagesViewDelegate</span><span class="p">:</span> <span class="kt">NSObjectProtocol</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">didAction</span><span class="p">(</span><span class="n">_</span> <span class="nv">view</span><span class="p">:</span> <span class="kt">MessagesView</span><span class="p">,</span> <span class="nv">action</span><span class="p">:</span> <span class="kt">ViewAction</span><span class="p">,</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">ViewState</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The relevant code is <a href="https://github.com/twocentstudios/Messages-Translator-Extension/blob/master/MessagesExtension/MessagesView.swift">here</a>.</p>

<p>Another valid implementation would be to use two or more <code class="language-plaintext highlighter-rouge">UIViewController</code> subclasses and the UIViewController containment APIs.</p>

<h3 id="controller">Controller</h3>

<p><code class="language-plaintext highlighter-rouge">MessagesViewController</code> is our <code class="language-plaintext highlighter-rouge">MSMessagesAppViewController</code> subclass. It will be responsible for performing most of the data transformations, holding state through the extension’s lifecycle, and handling other calls from Messages.app.</p>

<p>Our controller has two instance variables:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">@IBOutlet weak var messagesView: MessagesView!</code>: our only view.</li>
  <li><code class="language-plaintext highlighter-rouge">var pair: Pair?</code>: the current model. We need to hold onto this temporarily while we’re waiting for user input in order to do the <code class="language-plaintext highlighter-rouge">ViewAction + Pair -&gt; Pair</code> transformation. This value may also change if we’re performing a <code class="language-plaintext highlighter-rouge">ViewAction</code> that is not intended to produce an <code class="language-plaintext highlighter-rouge">MSMessage</code> but only alter the <code class="language-plaintext highlighter-rouge">ViewState</code> directly (e.g. <code class="language-plaintext highlighter-rouge">ViewState.promptNew -&gt; ViewState.translationNew</code>).</li>
</ul>

<h3 id="entry-point">Entry Point</h3>

<p>The entry point of our extension in the general case will be:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="c1">// MessagesViewController.swift</span>
<span class="k">override</span> <span class="kd">func</span> <span class="nf">willBecomeActive</span><span class="p">(</span><span class="n">with</span> <span class="nv">conversation</span><span class="p">:</span> <span class="kt">MSConversation</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// ... }</span>
</code></pre>
</div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">conversation.selectedMessage == nil</code>: the user opened our extension in the extension browser and will be creating a new translation or correction.</li>
  <li><code class="language-plaintext highlighter-rouge">conversation.selectedMessage != nil</code>: the user has tapped on a translation or correction embedded in an existing message in their timeline.</li>
</ul>

<p>The full implementation with transformations annotated:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">override</span> <span class="kd">func</span> <span class="nf">willBecomeActive</span><span class="p">(</span><span class="n">with</span> <span class="nv">conversation</span><span class="p">:</span> <span class="kt">MSConversation</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// MSConversation -&gt; MSMessage -&gt; URL -&gt; Model</span>
    <span class="k">self</span><span class="o">.</span><span class="n">pair</span> <span class="o">=</span> <span class="kt">Pair</span><span class="p">(</span><span class="nv">conversation</span><span class="p">:</span> <span class="n">conversation</span><span class="p">)</span>
    
    <span class="c1">// Model -&gt; ViewState</span>
    <span class="k">let</span> <span class="nv">viewState</span> <span class="o">=</span> <span class="kt">ViewState</span><span class="p">(</span><span class="nv">pair</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">pair</span><span class="p">)</span>
    
    <span class="c1">// ViewState -&gt; View</span>
    <span class="k">self</span><span class="o">.</span><span class="n">messagesView</span><span class="o">.</span><span class="n">viewState</span> <span class="o">=</span> <span class="n">viewState</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="exit-point">Exit Point</h3>

<p>The exit point of an Messages Extension in the general case will be a call to <code class="language-plaintext highlighter-rouge">MSConversation.insert</code> followed by <code class="language-plaintext highlighter-rouge">MyMessagesAppViewController.dismiss</code> and can be called from any part of your extension. This inserts a message (that your extension has just finished crafting) into the Messages.app’s main text field allowing the user to (optionally) tap the send button.</p>

<p>In our case, we’re channeling all user actions into the delegate method:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">didAction</span><span class="p">(</span><span class="n">_</span> <span class="nv">view</span><span class="p">:</span> <span class="kt">MessagesView</span><span class="p">,</span> <span class="nv">action</span><span class="p">:</span> <span class="kt">ViewAction</span><span class="p">,</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">ViewState</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// ... }</span>
</code></pre>
</div>

<p>There are a few resulting view states where the behavior of inserting a message and dismissing is not correct. If the user is in the compact view and has decided to start a new translation, they’re not finished interacting with our extension. In this case, we should request an expanded view:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="c1">// MessagesViewController.swift</span>
<span class="k">self</span><span class="o">.</span><span class="nf">requestPresentationStyle</span><span class="p">(</span><span class="o">.</span><span class="n">expanded</span><span class="p">)</span>
</code></pre>
</div>

<p>Let’s now walk through the entire function.</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">didAction</span><span class="p">(</span><span class="n">_</span> <span class="nv">view</span><span class="p">:</span> <span class="kt">MessagesView</span><span class="p">,</span> <span class="nv">action</span><span class="p">:</span> <span class="kt">ViewAction</span><span class="p">,</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">ViewState</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ViewAction + Pair -&gt; Pair</span>
    <span class="k">let</span> <span class="nv">newPair</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="nf">combine</span><span class="p">(</span><span class="nv">withPair</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">pair</span><span class="p">)</span>
    
    <span class="c1">// Pair -&gt; ViewState</span>
    <span class="k">let</span> <span class="nv">newViewState</span> <span class="o">=</span> <span class="kt">ViewState</span><span class="p">(</span><span class="nv">pair</span><span class="p">:</span> <span class="n">newPair</span><span class="p">)</span>
    
    <span class="k">switch</span> <span class="n">newViewState</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">promptNew</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">case</span> <span class="o">.</span><span class="n">translationNew</span><span class="p">,</span> <span class="o">.</span><span class="nv">correctionNew</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="nf">requestPresentationStyle</span><span class="p">(</span><span class="o">.</span><span class="n">expanded</span><span class="p">)</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">conversation</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">activeConversation</span> <span class="k">else</span> <span class="p">{</span> <span class="nf">fatalError</span><span class="p">(</span><span class="s">"Expected a conversation"</span><span class="p">)</span> <span class="p">}</span>
        
        <span class="c1">// Always replace the selectedMessage by passing its `MSSession`.</span>
        <span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="n">conversation</span><span class="o">.</span><span class="n">selectedMessage</span><span class="p">?</span><span class="o">.</span><span class="n">session</span> <span class="p">??</span> <span class="kt">MSSession</span><span class="p">()</span>
        
        <span class="c1">// Pair -&gt; MSMessage</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">message</span> <span class="o">=</span> <span class="n">newPair</span><span class="o">.</span><span class="nf">composeMessage</span><span class="p">(</span><span class="n">session</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="nf">fatalError</span><span class="p">(</span><span class="s">"Expected a message"</span><span class="p">)</span> <span class="p">}</span>
        
        <span class="c1">// ViewState -&gt; String</span>
        <span class="k">let</span> <span class="nv">changeDescription</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="nf">changeDescription</span><span class="p">()</span>
        
        <span class="c1">// MSMessage + String</span>
        <span class="n">conversation</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nv">localizedChangeDescription</span><span class="p">:</span> <span class="n">changeDescription</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// ... }</span>
        
        <span class="k">self</span><span class="o">.</span><span class="nf">dismiss</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="c1">// Set the new Pair and ViewState on our view controller</span>
    <span class="c1">// for the next run cycle.</span>
    <span class="k">self</span><span class="o">.</span><span class="n">pair</span> <span class="o">=</span> <span class="n">newPair</span>
    <span class="k">self</span><span class="o">.</span><span class="n">messagesView</span><span class="o">.</span><span class="n">viewState</span> <span class="o">=</span> <span class="n">newViewState</span>
<span class="p">}</span>
</code></pre>
</div>

<p>As you can see, we’re mostly applying transformations based on the user’s action (<code class="language-plaintext highlighter-rouge">ViewAction</code>), the input pair we saved earlier (<code class="language-plaintext highlighter-rouge">self.pair</code>), and some state saved in the superclass <code class="language-plaintext highlighter-rouge">MSMessagesAppViewController</code> (<code class="language-plaintext highlighter-rouge">self.activeConversation.selectedMessage.session</code>). These transformations produce a new <code class="language-plaintext highlighter-rouge">Pair</code> and <code class="language-plaintext highlighter-rouge">ViewState</code>, and the side effect of either an inserted <code class="language-plaintext highlighter-rouge">MSMessage</code> in the conversation or a view state change.</p>

<p>All side effects are located in our class closest to the outside world (the view controller), while other classes and structs define valid transformations. Notice in particular that the view does not change its own state directly from user actions such as button presses.</p>

<h3 id="more-complicated-flows">More Complicated Flows</h3>

<p>We’ve now looked at the most common lifecycle of <code class="language-plaintext highlighter-rouge">input -&gt; user action -&gt; output</code>. Now let’s look at some other cases.</p>

<h4 id="willselect--didselect">willSelect &amp; didSelect</h4>

<p>If your extension is already active when the user taps one of your extension’s messages, the extension doesn’t have to launch and therefore won’t call our view controller’s <code class="language-plaintext highlighter-rouge">willBecomeActive</code> &amp; <code class="language-plaintext highlighter-rouge">didBecomeActive</code> as we were expecting. Instead, it will call <code class="language-plaintext highlighter-rouge">willSelect</code> &amp; <code class="language-plaintext highlighter-rouge">didSelect</code>, so we also need to set the <code class="language-plaintext highlighter-rouge">Pair</code> and <code class="language-plaintext highlighter-rouge">ViewState</code> from this entry point too. Unfortunately, at iOS 10 beta1, <code class="language-plaintext highlighter-rouge">willSelect</code> &amp; <code class="language-plaintext highlighter-rouge">didSelect</code> don’t seem to be implemented. This was confirmed as a known issue in beta2. The workaround is to place this behavior in <code class="language-plaintext highlighter-rouge">willTransition</code>.</p>

<h4 id="didreceive">didReceive</h4>

<p>While your extension is active, it’s possible that one of the conversation’s other participants will send a message to your extension. The original sender could have updated the message, or a third member of the group could have replied. In either case, you can monitor <code class="language-plaintext highlighter-rouge">didRecieve</code> to react to new messages outside of the <code class="language-plaintext highlighter-rouge">input -&gt; user action -&gt; output</code> cycle presented earlier and optionally alert the local participant that something has changed since they opened your extension.</p>

<h4 id="didstartsending--didcancelsending">didStartSending &amp; didCancelSending</h4>

<p>If you need to take direct action based on the user attempting to send or deciding not to send your message after it’s been inserted into the conversation, override your view controller’s <code class="language-plaintext highlighter-rouge">didStartSending</code> and/or <code class="language-plaintext highlighter-rouge">didCancelSending</code> functions. These would presumably be called after you’ve called <code class="language-plaintext highlighter-rouge">dismiss</code> inside the defacto exit point I described earlier.</p>

<p>Notice that <code class="language-plaintext highlighter-rouge">didStartSending</code> is called on an <em>attempt</em> to send, i.e. when the user taps the Messages.app’s send button. Apple doesn’t guarantee the message will be delivered to the other participants. This could create a few opportunities for edge cases you should be aware of. For example, if the message service goes down and you’ve <code class="language-plaintext highlighter-rouge">POST</code>ed resource state changes to your server successfully in <code class="language-plaintext highlighter-rouge">didStartSending</code>, other participants may see outdated information in their message’s <code class="language-plaintext highlighter-rouge">MSMessageTemplateLayout</code> that represents that resource on your server. Rare, but still something to think about that synchronizing state using <code class="language-plaintext highlighter-rouge">MSMessage</code>s will not always be perfect.</p>

<p>Note that there also may be an issue with these two delegate methods with iOS 10 beta1 as well, possibly on the simulator but not real devices.</p>

<h3 id="wrap-up">Wrap Up</h3>

<p>We’ve finished the basic walkthrough of our example Messages Extension. We haven’t used all that Messages.framework is capable of, so we’ll now take a look at some advanced features.</p>

<h2 id="more-advanced-features">More Advanced Features</h2>

<p>Well, some of these features are advanced. Others I just didn’t have an immediate use for in the example app. In any case…</p>

<h3 id="collapsed-view-state">Collapsed View State</h3>

<p>When your <code class="language-plaintext highlighter-rouge">MSMessagesAppViewController</code> is in its collapsed state, it won’t have access to horizontal swipe or pan gestures. That’s how users will swipe between different extensions.</p>

<p>Your text fields or anything that requires a keyboard will also be disabled since the keyboard would otherwise obscure your view.</p>

<h3 id="expanding-the-view-state">Expanding The View State</h3>

<p>When your extension is launched by a user tapping an existing message, the view controller is automatically launched into expanded mode by Messages.app.</p>

<p>You can also request that your app be expanded after it has started in compact mode. In my tests on the simulator, my request to expand my extension was accepted no earlier than 0.3 seconds after <code class="language-plaintext highlighter-rouge">viewDidAppear</code>, the final callback we get from the view system (I set a timer). Those numbers may change, but the takeaway is that you can’t <em>immediately</em> expand your extension with no user interaction having taken place.</p>

<h3 id="saved-screenshots">Saved Screenshots</h3>

<p>Similar to how suspended apps are snapshotted by iOS before moving to the background, the same is done with Messages Extensions to give them the appearance of quick activation. Messages.app kills and revives extensions quite aggressively too. In the beta, this has led to some funky looking intermediate view states.</p>

<div class="caption-wrapper"><img class="caption" src="/images/messages-startup-artifacts-small.png" width="" height="" alt="IceCreamBuilder looking a little stretched out." title="IceCreamBuilder looking a little stretched out." /><div class="caption-text">IceCreamBuilder looking a little stretched out.</div></div>

<h3 id="testing-in-the-simulator">Testing in the Simulator</h3>

<p>Messages.app was added to the iOS simulator on iOS 10 to assist in debugging extensions. On every cold launch, Messages.app in the simulator is seeded with two conversation threads that are tied together. You can send messages from messagesuser1@simulated.icloud.com by tapping on the first thread and from messagesuser2@simulated.icloud.com by tapping on the second thread.</p>

<p>You can clear the message history by force quitting Messages.app. It’s also cleared any time you recompile and attach the debugger. According to the release notes this may not be the behavior intended by Apple though.</p>

<p>I had some trouble using the macOS hardware keyboard with my extension’s text fields in the beta.</p>

<div class="caption-wrapper"><img class="caption" src="/images/messages-simulator-home-small.png" width="" height="" alt="Messages.app in the iOS Simulator." title="Messages.app in the iOS Simulator." /><div class="caption-text">Messages.app in the iOS Simulator.</div></div>

<h3 id="landscape-support">Landscape Support</h3>

<p>Apple <a href="https://forums.developer.apple.com/thread/50524">requires</a> that Messages Extensions support both landscape and portrait as there is no way to prevent the normal autorotation behavior of Messages.app.</p>

<h3 id="msmessage">MSMessage</h3>

<p>As the unit encapsulating data and view specification, <code class="language-plaintext highlighter-rouge">MSMessage</code> has a few points we should cover.</p>

<h4 id="accessibility">Accessibility</h4>

<p>The second “view” of a message if you will is the <code class="language-plaintext highlighter-rouge">accessibilityLabel</code> property. You should use this label to specifically spell out any implicit context in the <code class="language-plaintext highlighter-rouge">MSMessageTemplateLayout</code>.</p>

<h4 id="session">Session</h4>

<p>We ran into <code class="language-plaintext highlighter-rouge">MSSession</code> briefly in the sample app. The <code class="language-plaintext highlighter-rouge">MSSession</code> is an identifier you can use to link messages together. Messages.app will replace the contents of any previous message with the same session. When preparing an <code class="language-plaintext highlighter-rouge">MSMessage</code> for the user, if the message represents a resource that already exists, you should initialize the <code class="language-plaintext highlighter-rouge">MSMessage</code> with the previous <code class="language-plaintext highlighter-rouge">MSMessage</code>’s <code class="language-plaintext highlighter-rouge">MSSession</code>. Otherwise, use the designated initializer <code class="language-plaintext highlighter-rouge">MSSession()</code> to create a new one.</p>

<h4 id="app-icon">App Icon</h4>

<p>Your extension’s icon will appear in the top left corner of any message created by your extension.</p>

<p>In our example extension, you’ll notice that since we don’t send an image or video, our app icon covers up part of the caption. Hopefully that’s something that will be fixed by Apple before launch.</p>

<h4 id="nscoding">NSCoding</h4>

<p><code class="language-plaintext highlighter-rouge">MSMessage</code> conforms to both <code class="language-plaintext highlighter-rouge">NSSecureCoding</code> and <code class="language-plaintext highlighter-rouge">NSCopying</code> making life a bit easier if you wanted to save messages wholesale.</p>

<h4 id="participants">Participants</h4>

<p>Due to privacy concerns, the identities of a conversation’s participants are obscured through the use of UUIDs.</p>

<ul>
  <li>You can identify a message’s sender from <code class="language-plaintext highlighter-rouge">MSMessage.senderParticipantIdentifier</code>.</li>
  <li>You can identify the local user from <code class="language-plaintext highlighter-rouge">MSConversation.localParticipantIdentifier</code>.</li>
  <li>You can identify all other participants from <code class="language-plaintext highlighter-rouge">MSConversation.remoteParticipantIdentifiers</code>.</li>
</ul>

<p>These three properties should be enough for your extension to determine at any given time whether a message was sent by the current user.</p>

<p>You can insert these UUIDs directly into user-facing strings within <code class="language-plaintext highlighter-rouge">MSMessageTemplateLayout()</code> prefixed with a <code class="language-plaintext highlighter-rouge">$</code> and Messages.app will replace them with the contact’s actual name before showing them to the user. However on the iOS Simulator and iOS 10 beta1 I haven’t be able to reproduce the intended behavior. It still shows up as the raw UUID string in Messages (thanks to <a href="https://twitter.com/zachsimone">@zachsimone</a> for the heads up). <em>Update 7/7/16: Fixed in beta2.</em></p>

<p>For example:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="k">let</span> <span class="nv">layout</span> <span class="o">=</span> <span class="kt">MSMessageTemplateLayout</span><span class="p">()</span>
<span class="n">layout</span><span class="o">.</span><span class="n">caption</span> <span class="o">=</span> <span class="s">"My name is $</span><span class="se">\(</span><span class="n">conversation</span><span class="o">.</span><span class="n">localParticipantIdentifer</span><span class="o">.</span><span class="n">uuidString</span><span class="se">)</span><span class="s">."</span>
<span class="n">conversation</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nv">localizedChangeDescription</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
</code></pre>
</div>

<h4 id="msmessagetemplatelayout-attributes">MSMessageTemplateLayout Attributes</h4>

<p>A couple quick notes on <code class="language-plaintext highlighter-rouge">MSMessageTemplateLayout</code>’s attributes.</p>

<ul>
  <li>If you include both <code class="language-plaintext highlighter-rouge">image</code> and <code class="language-plaintext highlighter-rouge">mediaFileURL</code>, <code class="language-plaintext highlighter-rouge">mediaFileURL</code> will be ignored.</li>
  <li>Apple recommends your images be 300x300pt @3x, but also says you should experiment with what looks best for your use case.</li>
  <li><code class="language-plaintext highlighter-rouge">mediaFileURL</code>/<code class="language-plaintext highlighter-rouge">image</code> can be an PNG, JPEG, GIF, or video.</li>
  <li>Media will be compressed before being sent.</li>
  <li>You should avoid writing text to an image due to possible compression/scaling artifacts rendering it illegible.</li>
  <li>If you don’t include an <code class="language-plaintext highlighter-rouge">image</code> or <code class="language-plaintext highlighter-rouge">mediaFileURL</code> in your template, <code class="language-plaintext highlighter-rouge">imageTitle</code> and <code class="language-plaintext highlighter-rouge">imageSubtitle</code> will be ignored.</li>
  <li><code class="language-plaintext highlighter-rouge">caption</code> is limited to 3 lines with an automatically added trailing ellipsis.</li>
  <li><code class="language-plaintext highlighter-rouge">subcaption</code> is not shown unless a caption is present.</li>
  <li><code class="language-plaintext highlighter-rouge">subcaption</code> is limited to 1 line and no trailing ellipsis is added.</li>
  <li><code class="language-plaintext highlighter-rouge">trailingCaption</code>/<code class="language-plaintext highlighter-rouge">trailingSubcaption</code> seem to mirror the behavior of their <code class="language-plaintext highlighter-rouge">caption</code>/<code class="language-plaintext highlighter-rouge">subcaption</code> counterparts.</li>
</ul>

<div class="caption-wrapper"><img class="caption" src="/images/messages-template-layout-test-large.png" width="" height="" alt="Various configurations of MSMessageTemplateLayout." title="Various configurations of MSMessageTemplateLayout." /><div class="caption-text">Various configurations of MSMessageTemplateLayout.</div></div>

<h4 id="urls">URLs</h4>

<p>As previously mentioned, the URL you attach to an <code class="language-plaintext highlighter-rouge">MSMessage</code> will be available directly to the user in two cases:</p>

<ul>
  <li>The recipient views the message on iOS 9 or earlier.</li>
  <li>The recipient views the message on macOS.</li>
</ul>

<p>If your app does not have a default web presence that can render these links in a web browser, you may want to have the base URL point to a sort of 404 explanation page. Something like “Hey, you received a link created with MyApp. Open it on an iOS 10+ device to get started.” You can still encode parameters in the query string this way.</p>

<p>Another gotcha is that only http/https scheme URLs will be sent to other platforms. If your message doesn’t lose any context without a URL, you can use this to your advantage and not worry about implementing the 404 page.</p>

<h4 id="expiring">Expiring</h4>

<p>You can set your messages to expire by default by setting <code class="language-plaintext highlighter-rouge">shouldExpire</code> on the <code class="language-plaintext highlighter-rouge">MSMessage</code> instance. This behavior is the same as other Messages.app expiring messages and can be overridden by the recipient.</p>

<h3 id="icon-template-sizes">Icon Template Sizes</h3>

<p>For reference, here are the listed sizes for Messages App Icons.</p>

<p>Messages: 27x20pt @1x @2x @3x
Messages: 32x24pt @1x @2x @3x
Messages App Store: 1024x768pt @1x
Messages iPhone: 60x45pt @2x @3x
Messages iPad: 67x50pt @1x @2x
Messages iPad Pro: 74x55pt @2x</p>

<div class="caption-wrapper"><img class="caption" src="/images/messages-app-icon-sizes.png" width="" height="" alt="Various configurations of MSMessageTemplateLayout." title="Various configurations of MSMessageTemplateLayout." /><div class="caption-text">Various configurations of MSMessageTemplateLayout.</div></div>

<h3 id="stickers">Stickers</h3>

<p>I’ve neglected the sticker classes, but these are worth mentioning as many extensions will be sticker focused. Apple’s IceCreamBuilder example extension uses these classes.</p>

<h4 id="mssticker">MSSticker</h4>

<p><code class="language-plaintext highlighter-rouge">MSSticker</code> is the model class for stickers.</p>

<p>Create <code class="language-plaintext highlighter-rouge">MSSticker</code> by passing in a <code class="language-plaintext highlighter-rouge">fileURL</code> and <code class="language-plaintext highlighter-rouge">localizedDescription</code> of the sticker contents. The initializer can throw an <code class="language-plaintext highlighter-rouge">NSError</code>. From the docs:</p>

<ul>
  <li>The file must have a maximum size of 500KB.</li>
  <li>The file must conform to kUTTypePNG, kUTTypeGIF or kUTTypeJPEG.</li>
  <li>The image loaded from the file must be no smaller than 300px X 300px and must be no larger 618px x 618px.</li>
</ul>

<h4 id="msstickerview">MSStickerView</h4>

<p>The drop-in <code class="language-plaintext highlighter-rouge">UIView</code> subclass for stickers is <code class="language-plaintext highlighter-rouge">MSStickerView</code>. Initialize it with an <code class="language-plaintext highlighter-rouge">MSSticker</code> or set the <code class="language-plaintext highlighter-rouge">sticker</code> property later.</p>

<p>This class provides drag and drop behavior for pulling stickers from the collapsed view of an extension into the main conversation. It also provides outlets for inspecting and controlling animation of GIFs:</p>

<div class="language-swift highlighter-rouge"><pre class="highlight"><code><span class="c1">// MSStickerView.swift (abridged)</span>
<span class="kd">public</span> <span class="k">var</span> <span class="nv">animationDuration</span><span class="p">:</span> <span class="kt">TimeInterval</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
<span class="kd">public</span> <span class="kd">func</span> <span class="nf">startAnimating</span><span class="p">()</span>
<span class="kd">public</span> <span class="kd">func</span> <span class="nf">stopAnimating</span><span class="p">()</span>
<span class="kd">public</span> <span class="kd">func</span> <span class="nf">isAnimating</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
</code></pre>
</div>

<h2 id="things-you-cant-do">Things You Can’t Do</h2>

<p>I’ve seen a few questions already on the developer forums about what can and can’t be done. I’ll document a few of those here and may add more in the future.</p>

<h3 id="sending-messages-without-user-interaction">Sending Messages Without User Interaction</h3>

<p>You cannot send a message directly on behalf of the user. That means you cannot skip the part where your newly minted message is deposited into the Messages.app text field and the user taps the send button. Apple wants to make sure that the user has the final say on what is sent on their behalf.</p>

<h3 id="accessing-text-or-messages-not-created-by-your-app">Accessing Text Or Messages Not Created By Your App</h3>

<p>You cannot access any information that was not created specifically by your extension. That means you cannot access the contents of Message.app’s text field directly. You cannot access any other messages in the conversation history.</p>

<p>Any text input you require must be entered by the user into a text field you’ve created in the expanded mode of your extension.</p>

<h2 id="known-issues">Known Issues</h2>

<p>I’ve mentioned a few of the known issues in the text above. Here are a few more I’ll add to as they’re reported and resolved.</p>

<h3 id="changes-to-insertmessage">Changes to insertMessage</h3>

<p>The function signature of <code class="language-plaintext highlighter-rouge">MSConversation.insertMessage</code> has changed (beta1 -&gt; beta2) for an unknown reason. The <code class="language-plaintext highlighter-rouge">localizedChangeDescription</code> parameter was removed. There is currently no way that I can determine to create a change description. The documentation is also out of line with the function itself.</p>

<h2 id="wrap-up-1">Wrap Up</h2>

<p>I’ve given an overview of Messages Extensions. We then walked through an example extension that uses some of the available features of Messages.framework. Finally, we covered a few advanced features.</p>

<p>I’m excited to see what kinds of Messages Extensions are available at iOS 10 launch come this Fall.</p>

<p>I’ll do my best to keep this post updated as subsequent betas are shipped. Feel free to ping me <a href="https://twitter.com/twocentstudios">@twocentstudios</a> on Twitter if you have questions or comments.</p>

<p><em>Thanks to Evan Coleman for reading drafts of this post.</em></p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">twocentstudios</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li><a href="mailto:chris@twocentstudios.com">chris@twocentstudios.com</a></li>
          
          <li>
            <a href="https://github.com/twocentstudios">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">twocentstudios</span>
            </a>
          </li>
          

          <li>
            <a href="https://hackyderm.io/@twocentstudios">
              <span class="icon">
                <svg viewBox="0 0 24 24">
                  <path fill="#828282" d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/>
                </svg>
              </span>

              <span class="username">twocentstudios</span>
            </a>
          </li>

          
          <li>
            <a href="https://twitter.com/twocentstudios">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">twocentstudios</span>
            </a>
          </li>
          
        </ul>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
