<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>How I Wrote Vinylogue for iOS with ReactiveCocoa</title>

  <meta property="og:type" content="article" />
  <meta property="og:title" content="How I Wrote Vinylogue for iOS with ReactiveCocoa" />
  <meta property="og:url" content="https://twocentstudios.com/2013/04/03/the-making-of-vinylogue/" />
  
    <meta property="og:article:published_time" content="2013-04-03T12:36:00-05:00" />
  
  
  
  <link href='https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;350;400;600' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://twocentstudios.com/2013/04/03/the-making-of-vinylogue/">
  <link rel="alternate" type="application/rss+xml" title="twocentstudios" href="https://twocentstudios.com/feed.xml" />
</head>

  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NE82N02W8S"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NE82N02W8S');
</script>

  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">twocentstudios</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
          <a class="page-link" href="/blog/">Blog</a>
          
        
          
        
          
        
          
          <a class="page-link" href="/portfolio/">Portfolio</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">How I Wrote Vinylogue for iOS with ReactiveCocoa</h1>
    <p class="post-meta">Apr 3, 2013</p>
  </header>

  <article class="post-content">
    <p><a href="http://twocentstudios.com/apps/vinylogue" title="vinylogue">Vinylogue</a> is a simple app I designed and developed for iOS that shows your last.fm weekly album charts from previous years. This post will detail the process of creating V1.0 of the app from start to almost finish (is an app ever really finished?).</p>

<p>The full source is available <a href="https://github.com/twocentstudios/vinylogue">on GitHub</a>.</p>

<p>Warning: this post is super long (10000+ words). I spend a lot of time discussing ReactiveCocoa techniques, a little bit of time on pre-production, and a little bit of time on design.</p>

<h3 id="contents">Contents</h3>

<ul>
  <li><a href="#idea">Idea</a></li>
  <li><a href="#planning">Planning</a></li>
  <li><a href="#development1">Development pt.1</a></li>
  <li><a href="#design">Design</a></li>
  <li><a href="#development2">Development pt.2</a></li>
  <li><a href="#end">End</a></li>
</ul>

<h2 id="idea"><a href="id:idea">Idea</a></h2>

<p>I recently came across an awesome app called <a href="http://timehop.com">TimeHop</a> that compiles your past posts from Facebook, Twitter, etc. and shows you what you posted on that day one year ago. I love reminiscing through my old things, so this concept was right up my alley.</p>

<p>I also love music too though, and have been an avid <a href="http://last.fm">Last.fm</a> user since 2006 or 2007, scrobbling tracks religiously. I thus have quite a history of my past album listens in their database, and with those listens, a lot of memories connected to those albums. I can remember exactly what I was doing, where I was, and mental snapshots when I see an album or group of albums together.</p>

<p>And so the idea of combining Last.fm and TimeHop was born.</p>

<h2 id="planning"><a href="id:planning">Planning</a></h2>

<h3 id="getting-a-feel-for-the-data">Getting a feel for the data</h3>

<p>The first step was seeing what data was available from the Last.fm API. I could indeed get a weekly album chart (a list of albums, ranked by number of plays) for a specified user and week with <a href="http://www.last.fm/api/show/user.getWeeklyAlbumChart">user.getWeeklyAlbumChart</a>. It’s also possible to get the same chart grouped by artist or track, but at the current time it seemed like albums would appeal to me most.</p>

<p>One of the great things about this particular API call is that you don’t need a password for the username you’re requesting. One of the bad things was that you can’t just send a particular timestamp and let Last.fm figure out what week that date falls into.</p>

<p>The latter problem is solved by making another API request to <a href="http://www.last.fm/api/show/user.getWeeklyChartList">user.getWeeklyChartList</a>. This call provides the specific weekly date ranges in Epoch timestamps you can then use as an input to the user.getWeeklyAlbumChart call. The data looks something like this:</p>

<blockquote>
  <p>user.getWeeklyChartList</p>
</blockquote>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">{</span>
    <span class="s2">"chart"</span><span class="err">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">"from"</span><span class="p">:</span> <span class="s2">"1108296002"</span><span class="p">,</span>
            <span class="s2">"to"</span><span class="p">:</span> <span class="s2">"1108900802"</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">"from"</span><span class="p">:</span> <span class="s2">"1108900801"</span><span class="p">,</span>
            <span class="s2">"to"</span><span class="p">:</span> <span class="s2">"1109505601"</span>
        <span class="p">},</span>
        <span class="err">…</span>
    <span class="p">]</span>
<span class="p">}</span></code></pre></figure>

<p>Two API calls so far to get most of our data. Not bad. So to document our information flow:</p>

<ul>
  <li>take the current date</li>
  <li>subtract <code class="language-plaintext highlighter-rouge">n</code> years (1 year ago to start)</li>
  <li>figure out where that date is within the bounds of the Last.fm weeks</li>
  <li>request the charts for the username and date range</li>
  <li>display the data</li>
</ul>

<p>Pretty simple. Time to dig in a little more.</p>

<h3 id="features">Features</h3>

<p>It’s best to draw a line in the sand about what the constraints of the app will be, at least in the first version. Below are my first set of constraints. They (inevitably) changed later in the project, and we’ll discuss those changes as we make them.</p>

<ul>
  <li>We’ll support only one last.fm user.</li>
  <li>The user can view charts from the week range exactly <code class="language-plaintext highlighter-rouge">n</code> years ago (with the lower bound provided by Last.fm).</li>
  <li>The user cannot view any charts newer than one year ago.</li>
  <li>The app has a chart view and a settings view (keeping it very simple).</li>
</ul>

<p>Again, I’ll discuss changes as they happened in the process.</p>

<h3 id="schema">Schema</h3>

<p>Next I had to decide how the data would be structured and stored. The initial options were:</p>

<h4 id="keep-everything-transient">Keep everything transient</h4>

<p>We should request everything from the network each time. Don’t store anything in Core Data. We’re only looking at old data and we don’t have to worry about realtime feeds so we can use the regular old NSURLCache and set our cache times basically forever (in practice, it’s a little more complicated than this).</p>

<p>(As an aside, I ended up using SDURLCache as a replacement for NSURLCache. From pure observation, NSURLCache was faster from memory, but I could not get it pull from disk between app terminations.)</p>

<p>The weekly charts technically only need to be pulled from the server once a year (I’ll leave that as an exercise to the reader as to why). The chart data for a particular week is only relevant once per year the way the app is set up.</p>

<p>At the end of the day, the URL cache ends up being a dumb key-value store keyed on URLs and returning raw json data.</p>

<ul>
  <li>Pros
    <ul>
      <li>Less complexity keeping data in sync.</li>
    </ul>
  </li>
  <li>Cons
    <ul>
      <li>More data transferred.</li>
      <li>Longer waiting for previously requested data.</li>
    </ul>
  </li>
</ul>

<h4 id="incrementally-build-our-own-database-of-the-data-we-request">Incrementally build our own database of the data we request</h4>

<p>We should set up a full schema of related objects. Data should be requested locally, and if it doesn’t exist, it should be requested from the server and added to the local database.</p>

<ul>
  <li>Pros
    <ul>
      <li>Speed of subsequent requests.</li>
      <li>Less API requests.</li>
      <li>May enable future features.</li>
    </ul>
  </li>
  <li>Cons
    <ul>
      <li>Much greater complexity keeping data in sync and knowing when the cache is invalid.</li>
      <li>More local storage required.</li>
    </ul>
  </li>
</ul>

<h4 id="decision">Decision</h4>

<p>I was much more inclined to build a local database, but a big goal of this project was a quick ship. I decided to take a few hours building something out with <a href="https://github.com/AFNetworking/AFIncrementalStore">AFIncrementalStore</a>. It didn’t take long to realize doing things this way would slow down development substantially. I decided to keep the local database method as a goal, but leave it until the app idea itself was validated with users. At the current time, it felt like premature optimization.</p>

<p>I went ahead with the two table Core Data schema since I already had it set up and my classes generated with <a href="https://github.com/rentzsch/mogenerator">Mogenerator</a>. I added fields for the data I wanted from the user.getWeeklyChartList API call.</p>

<p>Later, I would completely rid Core Data from the project and turn these model objects back into standard NSObject subclasses.</p>

<div class="caption-wrapper"><img class="caption" src="/images/vinylogue-schemav1.png" width="" height="" alt="Schema V1" title="Schema V1" /><div class="caption-text">Schema V1</div></div>

<h3 id="wireframing">Wireframing</h3>

<p>Since I now had an idea of what data I had to work with, it was time to put together wireframes of what the main views would look like.</p>

<p>The aim was simplicity. One main view that shows a single week’s charts. Another modal view for settings and about.</p>

<p>I wanted to go with a more classic look with a standard UINavigationBar. A UITableView as a given based on the nature of the data (unknown number of albums, 0 - ???).</p>

<div class="caption-wrapper"><img class="caption" src="/images/vinylogue-wireframe.jpg" width="" height="" alt="Essential elements of the weekly chart view / Proposed inter-year navigation mechanism" title="Essential elements of the weekly chart view / Proposed inter-year navigation mechanism" /><div class="caption-text">Essential elements of the weekly chart view / Proposed inter-year navigation mechanism</div></div>

<p>I also needed to show additional metadata including what week and year were being shown, and also what user was being shown. Maybe some sort of table header view?</p>

<p>The next decision was how the user should navigate to past and future years. The first thought was a pull-up-to-refresh-type control to go to the future, and a pull-down to go back. iOS users are pretty used to that control type being for refreshing data, and it probably wouldn’t work with the metadata on a table header view already. Not to mention the amount of scrolling it might take to get to the bottom of the table view.</p>

<p>My solution was to combine the metadata header view and selection into one view/control. I like sliding things, so sliding left and right would request future and past years, respectively. While creating the control later, I also decided that classic arrow buttons would be a good idea so the functionality was immediately discoverable.</p>

<div class="caption-wrapper"><img class="caption" src="/images/vinylogue-slideselectview.jpg" width="" height="" alt="SlideSelectView" title="SlideSelectView" /><div class="caption-text">SlideSelectView</div></div>

<p>And finally, there was the table view cell itself. I wanted to keep this classic. Album image on the left, artist above album name, artist reemphasized and album name emphasized, and play count on the accessory side. I also left a placeholder for the numbered rank above the album image, but decided it was unnecessary later in the process.</p>

<div class="caption-wrapper"><img class="caption" src="/images/vinylogue-cell.jpg" width="" height="" alt="Cell detail" title="Cell detail" /><div class="caption-text">Cell detail</div></div>

<p>I wanted to get a feel for the settings view too, so I sketched that out. When I was getting my first prototype results back, I realized that if you listen to a lot of mixes, you’ll have row after row of albums with 1 play. I personally wanted the option to only see “full” album listens, and decided to add an option to filter rows by play count.</p>

<div class="caption-wrapper"><img class="caption" src="/images/vinylogue-settings.jpg" width="" height="" alt="Settings view wireframe" title="Settings view wireframe" /><div class="caption-text">Settings view wireframe</div></div>

<h2 id="development"><a href="id:development1">Development</a></h2>

<p>Finally time to dig into some coding (for real)! Well, almost time…</p>

<h3 id="setup">Setup</h3>

<p>Up to this project, I still was git cloning all my external libraries into a lib folder and doing the target settings dance with static libraries. It seemed like <a href="http://cocoapods.org">CocoaPods</a> was nearly complete on all the popular and semi-popular open source libraries out there. I decided to give it a shot, and it turned out to be mostly a boon to development. I ran into a few snags when I was doing my first archive builds, but I’m of the persuasion now that every iOS project should budget at least a full day to dealing with Xcode quirks.</p>

<h3 id="reactivecocoa">ReactiveCocoa</h3>

<p>I first learned about <a href="https://github.com/ReactiveCocoa/ReactiveCocoa">ReactiveCocoa</a> (RAC) almost a year ago (Maybe March of 2012?) and was immediately interested and immediately confused. ReactiveCocoa is an Objective-C framework for Functional Reactive Programming. I spent a lot of time trying to understand the example projects and following development for the next few months. On a (yet to be released as of this writing) project before this one, I was comfortable enough with a few design patterns to use RAC in selected places throughout that app. Another one of my goals for this app was to try to use RAC wherever I could (and it made sense).</p>

<p>Luckily, RAC hit 1.0 right before I started the project and a substantial amount of <a href="https://github.com/ReactiveCocoa/ReactiveCocoa/tree/master/Documentation">documentation</a> was added. For a good, brief overview of the library, I also recommend the <a href="http://nshipster.com/reactivecocoa">NSHipster</a> writeup.</p>

<p>I’ll be explaining my RAC code in some detail later in this post. I want to preface it by saying that I am still very much an RAC newbie and still getting a feel for its patterns, limitations, quirks, etc. Keep that in mind when reading through the code.</p>

<h3 id="other-libraries">Other Libraries</h3>

<p>I tried to keep the dependencies lower than normal on this project. I did, however, use a few staples.</p>

<ul>
  <li><a href="https://github.com/AFNetworking/AFNetworking">AFNetworking</a> - the defacto iOS/OS X networking library.</li>
  <li><a href="https://github.com/rs/SDURLCache">SDURLCache</a> - didn’t add this until very close to shipping. I wrestled with NSURLCache during several non-adjacent coding sessions, and eventually decided to replace it with SDURLCache.</li>
  <li><a href="https://github.com/nicklockwood/ViewUtils">ViewUtils</a> - there’s a bunch of UIView categories out there. I do a lot of manual view layout, so this library was invaluable.</li>
  <li><a href="https://github.com/hsjunnesson/UIViewDrawRectBlock">DrawRectBlock</a> - I don’t like cluttering my file list with single-use view classes, so having access to drawRect when creating a new UIView is often helpful. (Especially with different colored top &amp; bottom borders).</li>
  <li><a href="https://testflightapp.com">TestFlightSDK</a> - getting feedback from beta testers has improved my apps and workflow a lot. TestFlight is definitely doing some great work for the iOS community.</li>
  <li><a href="http://crashlytics.com">Crashlytics</a> &amp; <a href="http://flurry.com">Flurry</a> - I spent an entire day before App Store submission trying to figure out the best way to do analytics and crash reports (and how all the libraries fit together). The jury is still out on this, but I have to note that the people at  Crashlytics were super helpful and responsive in getting me set up.</li>
</ul>

<h3 id="tcslastfmapiclient">TCSLastFMAPIClient</h3>

<p>We’re going to start development from the back end (data) and move towards the front (views).</p>

<p>There are some older Last.fm Objective-C clients on GitHub, but it made sense to write my own since I was only using a few of the API endpoints and I wanted to use RAC as much as possible.</p>

<h4 id="interface">Interface</h4>

<p>I followed the GitHub client RAC example as a template for my client. The initial interface looked like this:</p>

<blockquote>
  <p>(TCSLastFMAPIClient.h)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="cp">#import "AFHTTPClient.h"
</span>
<span class="k">@class</span> <span class="nc">RACSignal</span><span class="p">;</span>
<span class="k">@class</span> <span class="nc">WeeklyChart</span><span class="p">;</span>
<span class="k">@class</span> <span class="nc">WeeklyAlbumChart</span><span class="p">;</span>

<span class="k">@interface</span> <span class="nc">TCSLastFMAPIClient</span> <span class="p">:</span> <span class="nc">AFHTTPClient</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">userName</span><span class="p">;</span>

<span class="k">+</span> <span class="p">(</span><span class="n">TCSLastFMAPIClient</span> <span class="o">*</span><span class="p">)</span><span class="nf">clientForUserName</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">userName</span><span class="p">;</span>

<span class="c1">// returns a single NSArray of WeeklyChart objects
</span><span class="k">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="n">fetchWeeklyChartList</span><span class="p">;</span>

<span class="c1">// returns a single NSArray of WeeklyAlbumChart objects
</span><span class="k">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">fetchWeeklyAlbumChartForChart</span><span class="p">:(</span><span class="n">WeeklyChart</span> <span class="o">*</span><span class="p">)</span><span class="nv">chart</span><span class="p">;</span>

<span class="k">@end</span></code></pre></figure>

<p>A few things to notice:</p>

<ul>
  <li>We’re subclassing <a href="http://afnetworking.github.com/AFNetworking/Classes/AFHTTPClient.html">AFHTTPClient</a>.</li>
  <li>A client instance is specific to a last.fm user.</li>
  <li>We can request data from two API endpoints as discussed in the planning section.</li>
  <li>The <code class="language-plaintext highlighter-rouge">fetchWeeklyChartList</code> method only requires a username.</li>
  <li>the <code class="language-plaintext highlighter-rouge">fetchWeeklyAlbumChartForChart:</code> method requires a username and a WeeklyChart object returned by the former method. A WeeklyChart object simply holds an NSDate for <code class="language-plaintext highlighter-rouge">from</code> and <code class="language-plaintext highlighter-rouge">to</code>.</li>
</ul>

<p>I want to focus on the <code class="language-plaintext highlighter-rouge">RACSignal</code> return types. I say in the comments that the methods “return an NSArray…” when what I mean is that they immediately return an <code class="language-plaintext highlighter-rouge">RACSignal</code>. Subscribing to that signal will (usually) result in an <code class="language-plaintext highlighter-rouge">NSArray</code> being sent to the subscriber in the <code class="language-plaintext highlighter-rouge">sendNext</code> method.</p>

<p>It’s probably not immediately clear why I wouldn’t just return the <code class="language-plaintext highlighter-rouge">NSArray</code>, but bear with me.</p>

<h4 id="enqueuerequest">enqueueRequest</h4>

<p>Feel free to read the <a href="https://github.com/twocentstudios/vinylogue/blob/master/vinylogue/TCSLastFMAPIClient.m">full implementation</a>, but I’m going to focus on a few methods in particular to explain the RAC parts. I’ll explain this one inline with comments.</p>

<blockquote>
  <p>(TCSLastFMAPIClient.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="c1">// This is our request assembler/responder. 
// It sits closest to the network stack in the code we'll write.
</span><span class="k">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">enqueueRequestWithMethod</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">method</span> <span class="nf">path</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">path</span> <span class="nf">parameters</span><span class="p">:(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">parameters</span> <span class="p">{</span>

    <span class="c1">// An RACSubject is an RACSignal subclass that can 
</span>    <span class="c1">// be manually controlled. It's used to bridge the 
</span>    <span class="c1">// block callback structure of the AFHTTPRequestOperation to RAC.
</span>    <span class="n">RACReplaySubject</span> <span class="o">*</span><span class="n">subject</span> <span class="o">=</span> <span class="p">[</span><span class="n">RACReplaySubject</span> <span class="nf">subject</span><span class="p">];</span>
    
    <span class="n">NSMutableURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">requestWithMethod</span><span class="p">:</span><span class="n">method</span> <span class="nf">path</span><span class="p">:</span><span class="n">path</span> <span class="nf">parameters</span><span class="p">:</span><span class="n">parameters</span><span class="p">];</span>
    <span class="c1">// Network caching is such a fickle thing in iOS that I don't really rely on this to do anything
</span>    <span class="n">request</span><span class="p">.</span><span class="n">cachePolicy</span> <span class="o">=</span> <span class="n">NSURLRequestReturnCacheDataElseLoad</span><span class="p">;</span>
  
    <span class="c1">// We assemble our operation callbacks here
</span>    <span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">HTTPRequestOperationWithRequest</span><span class="p">:</span><span class="n">request</span> <span class="nf">success</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="n">id</span> <span class="n">responseObject</span><span class="p">)</span> <span class="p">{</span>
    
      <span class="c1">// Last.fm returns error codes in the JSON data,
</span>      <span class="c1">// so it makes sense to handle that on this level.
</span>      <span class="c1">// Our endpoint methods should only care about good responses.
</span>      <span class="n">NSNumber</span> <span class="o">*</span><span class="n">errorCode</span> <span class="o">=</span> <span class="p">[</span><span class="n">responseObject</span> <span class="nf">objectForKey</span><span class="p">:</span><span class="s">@"error"</span><span class="p">]</span><span class="err">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">errorCode</span><span class="p">){</span>
        <span class="c1">// Make a new error object with the message we get
</span>        <span class="c1">// from the JSON data.
</span>        <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSError</span> <span class="nf">errorWithDomain</span><span class="p">:</span><span class="s">@"com.twocentstudios.vinylogue"</span> <span class="nf">code</span><span class="p">:[</span><span class="n">errorCode</span> <span class="nf">integerValue</span><span class="p">]</span> <span class="nf">userInfo</span><span class="p">:</span><span class="err">@</span><span class="p">{</span> <span class="nf">NSLocalizedDescriptionKey</span><span class="p">:</span> <span class="p">[</span><span class="n">responseObject</span> <span class="nf">objectForKey</span><span class="p">:</span><span class="s">@"message"</span><span class="p">]</span> <span class="p">}]</span><span class="err">;</span>
        
        <span class="c1">// Subscribers will "subscribeError:" to this signal
</span>        <span class="c1">// to receive and handle the error. It also completes the request
</span>        <span class="c1">// (subscribeComplete: won't be called).
</span>        <span class="p">[</span><span class="n">subject</span> <span class="nf">sendError</span><span class="p">:</span><span class="n">error</span><span class="p">]</span><span class="err">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="c1">// If last.fm doesn't give us an error, go ahead and send
</span>        <span class="c1">// the response object along to the subscriber.
</span>        <span class="p">[</span><span class="n">subject</span> <span class="nf">sendNext</span><span class="p">:</span><span class="n">responseObject</span><span class="p">]</span><span class="err">;</span>
        
        <span class="c1">// There's not going to be any more data, so this
</span>        <span class="c1">// RACSignal is complete.
</span>        <span class="p">[</span><span class="n">subject</span> <span class="nf">sendCompleted</span><span class="p">]</span><span class="err">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="nf">failure</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// A network error is handled similarly to a Last.fm error.
</span>        <span class="p">[</span><span class="n">subject</span> <span class="nf">sendError</span><span class="p">:</span><span class="n">error</span><span class="p">]</span><span class="err">;</span>
    <span class="p">}];</span>
  
    <span class="p">[</span><span class="n">self</span> <span class="nf">enqueueHTTPRequestOperation</span><span class="p">:</span><span class="n">operation</span><span class="p">];</span>
    
    <span class="c1">// RAC can be used for threading.
</span>    <span class="c1">// In this case, we want our "sendNext:" calls to be
</span>    <span class="c1">// processed by the API endpoint functions on a 
</span>    <span class="c1">// background thread. That way, the UI doesn't hang
</span>    <span class="c1">// while we're moving data from JSON -&gt; new objects.
</span>    <span class="k">return</span> <span class="p">[</span><span class="n">subject</span> <span class="nf">deliverOn</span><span class="p">:[</span><span class="n">RACScheduler</span> <span class="nf">scheduler</span><span class="p">]];</span>
<span class="p">}</span></code></pre></figure>

<p>So that’s our first taste of RAC in action. RACSubjects are a little different than vanilla RACSignals, but again, they’re very useful in bridging standard Foundation to RAC.</p>

<h4 id="fetchweeklychartlist">fetchWeeklyChartList</h4>

<p>We’re now at the point where an endpoint function can specify a URL and HTTP method and get a response object to process. I’m only going to explain one of the API endpoint functions (the simplest one), but the other ones should be very similar.</p>

<blockquote>
  <p>(TCSLastFMAPIClient.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="c1">// A public API endpoint function exposed in our interface
</span><span class="k">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="n">fetchWeeklyChartList</span><span class="p">{</span>
    
  <span class="c1">// First, assemble a parameters dictionary to give to our enqueue method.
</span>  <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="err">@</span><span class="p">{</span><span class="s">@"method"</span><span class="o">:</span> <span class="s">@"user.getweeklychartlist"</span><span class="p">,</span>
                           <span class="s">@"user"</span><span class="o">:</span> <span class="n">self</span><span class="p">.</span><span class="n">userName</span><span class="p">,</span>
                           <span class="s">@"api_key"</span><span class="o">:</span> <span class="n">kTCSLastFMAPIKeyString</span><span class="p">,</span>
                           <span class="s">@"format"</span><span class="o">:</span> <span class="s">@"json"</span><span class="p">};</span>
                           
  <span class="c1">// This is one big method chain we're returning.
</span>  <span class="c1">// The first step is to get the proper request signal
</span>  <span class="c1">// from the enqueue method.
</span>  <span class="k">return</span> <span class="p">[[[</span><span class="n">self</span> <span class="nf">enqueueRequestWithMethod</span><span class="p">:</span><span class="s">@"GET"</span> <span class="nf">path</span><span class="p">:</span><span class="s">@""</span> <span class="nf">parameters</span><span class="p">:</span><span class="n">params</span><span class="p">]</span>
            
            <span class="c1">// Then we hijack the signal's response and run it 
</span>            <span class="c1">// through some processing first.
</span>            <span class="c1">//
</span>            <span class="c1">// The "map:" blocks below are called with any
</span>            <span class="c1">// objects sent through the signal's "sendNext" call.
</span>            <span class="c1">// In this example, that object happens to be the
</span>            <span class="c1">// responseObject, which is an NSDictionary created
</span>            <span class="c1">// from a JSON file received from Last.fm.
</span>            <span class="c1">// 
</span>            <span class="c1">// The first processing we'll do is 
</span>            <span class="c1">// pull the object array from its shell.
</span>            <span class="c1">// I'm using an NSDictionary category to define a 
</span>            <span class="c1">// "arrayForKey" method that always returns an array,
</span>            <span class="c1">// even if there's only one object present in the
</span>            <span class="c1">// original dictionary.
</span>           <span class="nl">map:</span><span class="o">^</span><span class="n">id</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="n">responseObject</span><span class="p">)</span> <span class="p">{</span>
             <span class="k">return</span> <span class="p">[[</span><span class="n">responseObject</span> <span class="nf">objectForKey</span><span class="p">:</span><span class="s">@"weeklychartlist"</span><span class="p">]</span> <span class="nf">arrayForKey</span><span class="p">:</span><span class="s">@"chart"</span><span class="p">]</span><span class="err">;</span>
             
           <span class="c1">// Next, we're going to iterate through the array
</span>           <span class="c1">// and replace dictionaries with WeeklyChart objects.
</span>           <span class="c1">// We use the "rac_sequence" method to turn an array
</span>           <span class="c1">// into an RACSequence, then use the map function to
</span>           <span class="c1">// do the replacement. Finally, we request a standard 
</span>           <span class="c1">// array object from the RACSequence object.
</span>           <span class="p">}]</span> <span class="nf">map</span><span class="p">:</span><span class="o">^</span><span class="n">id</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="n">chartList</span><span class="p">)</span> <span class="p">{</span>
             <span class="k">return</span> <span class="p">[[</span><span class="n">chartList</span><span class="p">.</span><span class="n">rac_sequence</span> <span class="nf">map</span><span class="p">:</span><span class="o">^</span><span class="n">id</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="n">chartDictionary</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">WeeklyChart</span> <span class="o">*</span><span class="n">chart</span> <span class="o">=</span> <span class="p">[[</span><span class="n">WeeklyChart</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">]</span><span class="err">;</span>
               <span class="n">chart</span><span class="p">.</span><span class="n">from</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSDate</span> <span class="nf">dateWithTimeIntervalSince1970</span><span class="p">:[[</span><span class="n">chartDictionary</span> <span class="nf">objectForKey</span><span class="p">:</span><span class="s">@"from"</span><span class="p">]</span> <span class="nf">doubleValue</span><span class="p">]]</span><span class="err">;</span>
               <span class="n">chart</span><span class="p">.</span><span class="n">to</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSDate</span> <span class="nf">dateWithTimeIntervalSince1970</span><span class="p">:[[</span><span class="n">chartDictionary</span> <span class="nf">objectForKey</span><span class="p">:</span><span class="s">@"to"</span><span class="p">]</span> <span class="nf">doubleValue</span><span class="p">]]</span><span class="err">;</span>
               <span class="k">return</span> <span class="n">chart</span><span class="err">;</span>
             <span class="p">}]</span> <span class="nf">array</span><span class="p">]</span><span class="err">;</span>
           <span class="p">}];</span>
  
<span class="p">}</span></code></pre></figure>

<p>So it might look a little hairy, but it’s essentially just a few processing steps chained together and all in once place.</p>

<p>We introduced the <code class="language-plaintext highlighter-rouge">RACSequence</code> at the end there to iterate through the array. There are more standard <code class="language-plaintext highlighter-rouge">NSArray</code> ways to do this, but <code class="language-plaintext highlighter-rouge">RACSequence</code>s are a subclass of <code class="language-plaintext highlighter-rouge">RACStream</code>s, which have a bunch of cool operators like <code class="language-plaintext highlighter-rouge">map</code>, <code class="language-plaintext highlighter-rouge">flatten</code>, <code class="language-plaintext highlighter-rouge">filter</code>, etc.</p>

<p>The main point to get out of this is that our API endpoint method defines several processing steps for a stream, then hands the stream off to its assumed subscriber. At the point the API endpoint method is called, none of this work will actually be done. It’s not until the subscriber has called <code class="language-plaintext highlighter-rouge">subscribeNext</code> on the returned signal that the network request and subsequent processing be done. The subscriber doesn’t even have to know that the original signal’s <code class="language-plaintext highlighter-rouge">next</code> values are being modified.</p>

<p>That about does it for the API client. To summarize, the data flow is as follows:</p>

<ul>
  <li>The client object’s owner (we’ll assume it’s a controller) requests a signal from a public API endpoint method like <code class="language-plaintext highlighter-rouge">fetchWeeklyChartList</code>.</li>
  <li>The API endpoint method asks the <code class="language-plaintext highlighter-rouge">enqueue</code> method for a new signal for a specific network request.</li>
  <li>The <code class="language-plaintext highlighter-rouge">enqueue</code> method creates a new manually controlled signal, sets up the signal so that it will send responses when the network call completes, and then passes the signal to the API endpoint method.</li>
  <li>The API endpoint method sets up a list of processing steps that must be done with responses that are known to be good.</li>
  <li>The API endpoint passes the signal back to the controller.</li>
</ul>

<p>At this point the signal is completely set up. It knows exactly where and how to get its data, and how to process the data once it has been received. But it is lazy and will only do so once the controller subscribes to it.</p>

<p>We haven’t shown the act of subscribing yet, and we’ll do that in the next section.</p>

<h3 id="tcsweeklyalbumchartviewcontroller">TCSWeeklyAlbumChartViewController</h3>

<p>Our primary view controller is called <code class="language-plaintext highlighter-rouge">TCSWeeklyAlbumChartViewController</code>. Its function is to request the weekly album charts for a particular user and display them in a table view. It also facilitates moving forward and backward in time to view charts from other years.</p>

<p>It was originally imagined that this would be, for lack of a better term, the root controller of the app. In its original implementation, it had many more responsibilities and had to be more mutable. During the coding process, the app architecture changed, allowing me to assume that the controller would have an immutable user, and simplifying things a bit.</p>

<h4 id="public-interface">Public Interface</h4>

<p>The interface for this controller is pretty simple. Just one designated initializer.</p>

<blockquote>
  <p>(TCSWeeklyAlbumChartViewController.h)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">@interface</span> <span class="nc">TCSWeeklyAlbumChartViewController</span> <span class="p">:</span> <span class="nc">UIViewController</span> <span class="o">&lt;</span><span class="n">UITableViewDataSource</span><span class="p">,</span> <span class="n">UITableViewDelegate</span><span class="o">&gt;</span>

<span class="o">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">initWithUserName</span><span class="o">:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">userName</span> <span class="n">playCountFilter</span><span class="o">:</span><span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span><span class="n">playCountFilter</span><span class="p">;</span>

<span class="k">@end</span></code></pre></figure>

<p>Our controller needs to know which user it should display data for. It also needs to know which albums will be filtered based on play count. This controller will also handle all delegate and datasource duties from within. As a side note, I sometimes separate table datasources and delegates out to be their own classes. For this particular controller, things haven’t gotten so complex that I’ve needed to refactor them out.</p>

<h4 id="private-interface">Private Interface</h4>

<p>It’s good OO practice to keep your class variables private by default, and that’s what we’ll do by defining our private interface in the source file. I’ll go through all the class variables we’ve defined.</p>

<h5 id="views">Views</h5>

<p>Let’s start with the views.</p>

<blockquote>
  <p>(TCSWeeklyAlbumChartViewController.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">@interface</span> <span class="nc">TCSWeeklyAlbumChartViewController</span> <span class="p">()</span>

<span class="c1">// Views
</span><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">TCSSlideSelectView</span> <span class="o">*</span><span class="n">slideSelectView</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">UITableView</span> <span class="o">*</span><span class="n">tableView</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">UIView</span> <span class="o">*</span><span class="n">emptyView</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">UIView</span> <span class="o">*</span><span class="n">errorView</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">UIImageView</span> <span class="o">*</span><span class="n">loadingImageView</span><span class="p">;</span>

<span class="p">...</span>

<span class="k">@end</span></code></pre></figure>

<p>The slideSelectView is the special view we use to move to past and future years. It sits on above the tableView and does not scroll.</p>

<p>The tableView displays an album and play count in each row.</p>

<p>The emptyView, errorView, and loadingImageView are used to show state to the user. The empty and error views are added and removed as subviews of the main view when necessary. The loadingImageView is a animated spinning record that is added as a custom view of the right bar button item.</p>

<h5 id="data">Data</h5>

<blockquote>
  <p>(TCSWeeklyAlbumChartViewController.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">@interface</span> <span class="nc">TCSWeeklyAlbumChartViewController</span> <span class="p">()</span>

<span class="p">...</span>

<span class="c1">// Datasources
</span><span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">userName</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">)</span> <span class="n">NSUInteger</span> <span class="n">playCountFilter</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">TCSLastFMAPIClient</span> <span class="o">*</span><span class="n">lastFMClient</span><span class="p">;</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSArray</span> <span class="o">*</span><span class="n">weeklyCharts</span><span class="p">;</span> <span class="c1">// list of to:from: dates we can request charts for
</span><span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSArray</span> <span class="o">*</span><span class="n">rawAlbumChartsForWeek</span><span class="p">;</span> <span class="c1">// unfiltered charts
</span><span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSArray</span> <span class="o">*</span><span class="n">albumChartsForWeek</span><span class="p">;</span> <span class="c1">// filtered charts to display
</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSCalendar</span> <span class="o">*</span><span class="n">calendar</span><span class="p">;</span> <span class="c1">// convenience reference
</span><span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSDate</span> <span class="o">*</span><span class="n">now</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSDate</span> <span class="o">*</span><span class="n">displayingDate</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">)</span> <span class="n">NSUInteger</span> <span class="n">displayingYearsAgo</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">WeeklyChart</span> <span class="o">*</span><span class="n">displayingWeeklyChart</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSDate</span> <span class="o">*</span><span class="n">earliestScrobbleDate</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSDate</span> <span class="o">*</span><span class="n">latestScrobbleDate</span><span class="p">;</span>

<span class="p">...</span>

<span class="k">@end</span></code></pre></figure>

<p>From a general overview, we’re storing all the data we need to display, including some intermediate states. Why keep the intermediate state? We’ll respond to changes in those intermediates and make the chain of events more malleable. Some variables will be observed by views. Some variables will be observed by RAC processing code to produce new values for other variables. As you’ll see in a moment, we can completely separate our view and data code by using intermediate state variables instead of relying on linear processes.</p>

<p>I’ll reprint our data flow from the planning section above adding some detail and variable names. Variables related to the step are in [brackets].</p>

<ul>
  <li>take the current date [<code class="language-plaintext highlighter-rouge">now</code>]</li>
  <li>subtract <code class="language-plaintext highlighter-rouge">n</code> years (1 year ago to start) [<code class="language-plaintext highlighter-rouge">displayingDate</code> &amp; <code class="language-plaintext highlighter-rouge">displayingYearsAgo</code> along with a convenience reference to the Gregorian <code class="language-plaintext highlighter-rouge">calendar</code>]</li>
  <li>figure out where that date is within the bounds of the Last.fm weeks [<code class="language-plaintext highlighter-rouge">weeklyCharts</code> &amp; <code class="language-plaintext highlighter-rouge">displayingWeeklyChart</code>]</li>
  <li>request the charts for the username and date range [<code class="language-plaintext highlighter-rouge">rawAlbumChartsForWeek</code>]</li>
  <li>filter the charts based on play count and display the data [<code class="language-plaintext highlighter-rouge">albumChartsForWeek</code>]</li>
  <li>We also need to calculate the date bounds we can show charts for [<code class="language-plaintext highlighter-rouge">earliestScrobbleDate</code> &amp; <code class="language-plaintext highlighter-rouge">latestScrobbleDate</code>]</li>
</ul>

<p>We store a lastFMClient instance to call on as our source of external data.</p>

<h5 id="controller-state">Controller state</h5>

<blockquote>
  <p>(TCSWeeklyAlbumChartViewController.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">@interface</span> <span class="nc">TCSWeeklyAlbumChartViewController</span> <span class="p">()</span>

<span class="c1">// ...
</span>
<span class="c1">// Controller state
</span><span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">)</span> <span class="n">BOOL</span> <span class="n">canMoveForwardOneYear</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">)</span> <span class="n">BOOL</span> <span class="n">canMoveBackOneYear</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">)</span> <span class="n">BOOL</span> <span class="n">showingError</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">showingErrorMessage</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">)</span> <span class="n">BOOL</span> <span class="n">showingEmpty</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">atomic</span><span class="p">)</span> <span class="n">BOOL</span> <span class="n">showingLoading</span><span class="p">;</span>

<span class="k">@end</span></code></pre></figure>

<p>We have some additional controller state variables set up. I have to admit that I’m not sure my implementation of empty/error views is the best. There was plenty of experimentation, and I ran into some trouble with threading. It works, but will eventually require a refactor.</p>

<p>canMoveForward/BackOneYear depend on which year the user is currently viewing as well as the earliest/latestScrobbleDate. The slideSelectView knows what it should allow based on these bools. Any of our data processes can decide they want to show an error, empty, or loading state. Other RAC processes observe these variables and show the appropriate views. (Again, this took some tweaking and is a little fragile.)</p>

<h4 id="loadview">loadView</h4>

<p>I’ll annotate loadView inline:</p>

<blockquote>
  <p>(TCSWeeklyAlbumChartViewController.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">loadView</span><span class="p">{</span>
    <span class="c1">// Create a blank root view
</span>    <span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIView</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">autoresizesSubviews</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
    
    <span class="c1">// Begin creating the view hierarchy
</span>    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">slideSelectView</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">];</span>
    
    <span class="c1">// loading view is shown as bar button item
</span>    <span class="n">UIBarButtonItem</span> <span class="o">*</span><span class="n">loadingItem</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIBarButtonItem</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithCustomView</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">loadingImageView</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">loadingImageView</span><span class="p">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">navigationItem</span><span class="p">.</span><span class="n">rightBarButtonItem</span> <span class="o">=</span> <span class="n">loadingItem</span><span class="p">;</span>
    
    <span class="c1">// double tap on the slide view to hide the nav bar and status bar
</span>    <span class="n">UITapGestureRecognizer</span> <span class="o">*</span><span class="n">doubleTap</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UITapGestureRecognizer</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithTarget</span><span class="p">:</span><span class="n">self</span> <span class="nf">action</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nf">doDoubleTap</span><span class="p">:)];</span>
    <span class="n">doubleTap</span><span class="p">.</span><span class="n">numberOfTapsRequired</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">slideSelectView</span><span class="p">.</span><span class="n">frontView</span> <span class="nf">addGestureRecognizer</span><span class="p">:</span><span class="n">doubleTap</span><span class="p">];</span>
<span class="p">}</span></code></pre></figure>

<p>All view attributes are defined in the view getters section. I’ve taken up this habit to keep my controllers a bit more tidy. The views are created at the first <code class="language-plaintext highlighter-rouge">self.[viewname]</code> call in loadView.</p>

<blockquote>
  <p>(TCSWeeklyAlbumChartViewController.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="c1">// This custom view does most of its own configuration
</span><span class="k">-</span> <span class="p">(</span><span class="n">TCSSlideSelectView</span> <span class="o">*</span><span class="p">)</span><span class="n">slideSelectView</span><span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_slideSelectView</span><span class="p">){</span>
    <span class="n">_slideSelectView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">TCSSlideSelectView</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">_slideSelectView</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// The tableview is also pretty vanilla. I'm using a custom
// inner shadow view (although it's still not quite perfect).
</span><span class="o">-</span> <span class="p">(</span><span class="n">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="n">tableView</span><span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_tableView</span><span class="p">){</span>
    <span class="n">_tableView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UITableView</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithFrame</span><span class="p">:</span><span class="n">CGRectZero</span> <span class="nf">style</span><span class="p">:</span><span class="n">UITableViewStylePlain</span><span class="p">];</span>
    <span class="n">_tableView</span><span class="p">.</span><span class="n">separatorStyle</span> <span class="o">=</span> <span class="n">UITableViewCellSeparatorStyleNone</span><span class="p">;</span>
    <span class="n">_tableView</span><span class="p">.</span><span class="n">backgroundView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">TCSInnerShadowView</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithColor</span><span class="p">:</span><span class="n">WHITE_SUBTLE</span> <span class="nf">shadowColor</span><span class="p">:</span><span class="n">GRAYCOLOR</span><span class="p">(</span><span class="mi">210</span><span class="p">)</span> <span class="nf">shadowRadius</span><span class="p">:</span><span class="mi">3</span><span class="p">.</span><span class="mi">0</span><span class="n">f</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">_tableView</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Spinning record animation. It uses 12 images in a standard UIImageView.
</span><span class="o">-</span> <span class="p">(</span><span class="n">UIImageView</span> <span class="o">*</span><span class="p">)</span><span class="n">loadingImageView</span><span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_loadingImageView</span><span class="p">){</span>
    <span class="n">_loadingImageView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIImageView</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithFrame</span><span class="p">:</span><span class="n">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">)];</span>
    <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">animationImages</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableArray</span> <span class="nf">arrayWithCapacity</span><span class="p">:</span><span class="mi">12</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
      <span class="p">[</span><span class="n">animationImages</span> <span class="nf">addObject</span><span class="p">:[</span><span class="n">UIImage</span> <span class="nf">imageNamed</span><span class="p">:[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"loading%02i"</span><span class="p">,</span> <span class="n">i</span><span class="p">]]];</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="n">_loadingImageView</span> <span class="nf">setAnimationImages</span><span class="p">:</span><span class="n">animationImages</span><span class="p">];</span>
    <span class="n">_loadingImageView</span><span class="p">.</span><span class="n">animationDuration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="n">f</span><span class="p">;</span> <span class="c1">// trial and error
</span>    <span class="n">_loadingImageView</span><span class="p">.</span><span class="n">animationRepeatCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// repeat forever
</span>  <span class="p">}</span>
  <span class="k">return</span> <span class="n">_loadingImageView</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h4 id="viewdidload--rac-setup">viewDidLoad &amp; RAC setup</h4>

<p>Now for the fun stuff. The majority of the controller’s functionality is set up in viewDidLoad within two helper methods, setUpViewSignals and setUpDataSignals.</p>

<blockquote>
  <p>(TCSWeeklyAlbumChartViewController.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">viewDidLoad</span><span class="p">{</span>
  <span class="p">[</span><span class="n">super</span> <span class="nf">viewDidLoad</span><span class="p">];</span>
  
  <span class="p">[</span><span class="n">self</span> <span class="nf">setUpViewSignals</span><span class="p">];</span>
  <span class="p">[</span><span class="n">self</span> <span class="nf">setUpDataSignals</span><span class="p">];</span>
  
  <span class="c1">// these assignments trigger the controller to begin its actions
</span>  <span class="n">self</span><span class="p">.</span><span class="n">now</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSDate</span> <span class="nf">date</span><span class="p">];</span>
  <span class="n">self</span><span class="p">.</span><span class="n">displayingYearsAgo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>I’m going to start with the view signals to stress that as long as we know the exact meaning of our state variables, we can set up our views to react to them without knowing when or where they will be changed.</p>

<p>But before we can read through the code, we’ll need a quick primer on some more bread-and-butter RAC methods.</p>

<h5 id="weakify--strongify">@weakify &amp; @strongify</h5>

<p>Because RAC is heavily block-based, we can use the <code class="language-plaintext highlighter-rouge">EXTScope</code> preprocessor definitions within the companion <code class="language-plaintext highlighter-rouge">libextobjc</code> library to save our sanity when passing variables into blocks. Simply throw a <code class="language-plaintext highlighter-rouge">@weakify(my_variable)</code> before your RAC blocks to avoid the retain cycles, and then <code class="language-plaintext highlighter-rouge">@strongify(my_variable)</code> within each block to ensure the variable is not released during the block’s execution. See the definitions <a href="https://github.com/jspahrsummers/libextobjc/blob/master/extobjc/EXTScope.h">here</a>.</p>

<h5 id="racable--racablewithstart">RACAble(…) &amp; RACAbleWithStart(…)</h5>

<p>RACAble is simply magic <a href="https://developer.apple.com/library/mac/#documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html">Key Value Observing</a>. From the documentation:</p>

<blockquote>
  <p>[RACAble] returns a signal which sends a value every time the value at the given path changes, and sends completed if self is deallocated.</p>
</blockquote>

<p>This will be the backbone of our RAC code and is probably the easiest place to get started with RAC. It’s easy to pepper these signals into existing code bases without having to rewrite from scratch. Or just use a few in a project to get started.</p>

<h5 id="setupviewsignals">setUpViewSignals</h5>

<p>Let’s dive right into our first view signal to get a feel for it. I’ve separated it out into several expressions in order to simplify the explanation. In the actual source, it’s a single expression.</p>

<blockquote>
  <p>(TCSWeeklyAlbumChartViewController.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="c1">// Subscribing to all the signals that deal with views and UI
</span><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">setUpViewSignals</span><span class="p">{</span>
  <span class="err">@weakify</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
  
  <span class="c1">// SlideSelectView: Top Label
</span>  <span class="c1">// Depends on: userName
</span>  <span class="n">RACSignal</span> <span class="o">*</span><span class="n">userNameSignal</span> <span class="o">=</span> <span class="n">RACAbleWithStart</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">userName</span><span class="p">);</span>
  
  <span class="c1">// View changes must happen on the main thread
</span>  <span class="p">[</span><span class="n">userNameSignal</span> <span class="nf">deliverOn</span><span class="p">:[</span><span class="n">RACScheduler</span> <span class="nf">mainThreadScheduler</span><span class="p">]];</span>
  
  <span class="c1">// Change views based on the value of userName
</span>  <span class="p">[</span><span class="n">userNameSignal</span> <span class="nf">subscribeNext</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">userName</span><span class="p">)</span> <span class="p">{</span>
    <span class="err">@strongify</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">userName</span><span class="p">){</span>
      <span class="n">self</span><span class="p">.</span><span class="n">slideSelectView</span><span class="p">.</span><span class="n">topLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"%@"</span><span class="p">,</span> <span class="n">userName</span><span class="p">]</span><span class="err">;</span>
      <span class="n">self</span><span class="p">.</span><span class="n">showingError</span> <span class="o">=</span> <span class="nb">NO</span><span class="err">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
      <span class="n">self</span><span class="p">.</span><span class="n">slideSelectView</span><span class="p">.</span><span class="n">topLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">@"No last.fm user"</span><span class="err">;</span>
      <span class="n">self</span><span class="p">.</span><span class="n">showingErrorMessage</span> <span class="o">=</span> <span class="s">@"No last.fm user!"</span><span class="err">;</span>
      <span class="n">self</span><span class="p">.</span><span class="n">showingError</span> <span class="o">=</span> <span class="nb">YES</span><span class="err">;</span>
    <span class="p">}</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">slideSelectView</span> <span class="nf">setNeedsLayout</span><span class="p">]</span><span class="err">;</span>
  <span class="p">}];</span> 
  
  <span class="err">…</span>

<span class="p">}</span></code></pre></figure>

<p>Let’s deconstruct this. <code class="language-plaintext highlighter-rouge">RACAbleWithStart(self.userName)</code> creates an <code class="language-plaintext highlighter-rouge">RACSignal</code>. Again, an <code class="language-plaintext highlighter-rouge">RACSignal</code> can send <code class="language-plaintext highlighter-rouge">next</code> (with a value) and <code class="language-plaintext highlighter-rouge">error</code> or <code class="language-plaintext highlighter-rouge">complete</code> messages to its subscribers.</p>

<p>The <code class="language-plaintext highlighter-rouge">WithStart</code> part sends the current value of <code class="language-plaintext highlighter-rouge">self.userName</code> when it subscribed to. Without this, the block in <code class="language-plaintext highlighter-rouge">subscribeNext</code> would not be executed until <code class="language-plaintext highlighter-rouge">self.userName</code> changes for the first time after this subscription is created. In our case, because <code class="language-plaintext highlighter-rouge">self.userName</code> is only set once in the controller’s <code class="language-plaintext highlighter-rouge">init</code> method (before the signal is created), it would never be called with a normal <code class="language-plaintext highlighter-rouge">RACAble</code>.</p>

<p>(At this point you may be wondering, “Why even observe the userName property if it’s guaranteed to never change within the controller?” That’s a good question. It’s partly vestigial from when the value could change. It would very much be possible to transplant the code from within the <code class="language-plaintext highlighter-rouge">subscribeNext</code> block to <code class="language-plaintext highlighter-rouge">viewDidLoad</code>, but as you’ll see it fits pretty well with the rest of the more dynamic view code.)</p>

<p>The next statement, <code class="language-plaintext highlighter-rouge">deliverOn:</code>, <del>modifies</del> transforms the signal into a new RACSignal on the specified thread to ensure <code class="language-plaintext highlighter-rouge">next</code> values are delivered on the main thread. This is a necessary because UIKit requires user interface changes to be done on the <a href="http://developer.apple.com/library/ios/#documentation/uikit/reference/UIKit_Framework/Introduction/Introduction.html#//apple_ref/doc/uid/TP40006955-CH1-SW1">main thread</a>. Like all other signal transformations, it only takes effect if the result is used.</p>

<p><code class="language-plaintext highlighter-rouge">subscribeNext</code> is where our reaction code goes. Basically saying, “When the value of <code class="language-plaintext highlighter-rouge">self.userName</code> changes, execute the following block with the new value.” In this example, we’re going to change a label to show the userName. If it’s <code class="language-plaintext highlighter-rouge">nil</code>, we’ll throw up the error view.</p>

<p>I could have also used another variation of the <code class="language-plaintext highlighter-rouge">subscribeNext</code> method like <code class="language-plaintext highlighter-rouge">subscribeNext:complete:</code> to also add a block to execute when the signal completes. We don’t really need to do anything on completion, so we’ll just add a block for <code class="language-plaintext highlighter-rouge">next:</code>.</p>

<p>Instead of the <code class="language-plaintext highlighter-rouge">if/else</code>, we could have used two separate subscriptions that first <code class="language-plaintext highlighter-rouge">filter</code> for <code class="language-plaintext highlighter-rouge">nil</code> or empty userName. To keep it simple though, we’ll just mix in the iterative style for now.</p>

<p>Alright, so one signal down. Let’s look at another common pattern: combining multiple signals.</p>

<blockquote>
  <p>(TCSWeeklyAlbumChartViewController.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">setUpViewSignals</span><span class="p">{</span>
    <span class="err">@weakify</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

    <span class="err">…</span>
    
    <span class="c1">// SlideSelectView: Bottom Label, Left Label, Right Label
</span>    <span class="c1">// Depend on: displayingDate, earliestScrobbleDate, latestScrobbleDate
</span>    <span class="n">RACSignal</span> <span class="o">*</span><span class="n">combinedSignal</span> <span class="o">=</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nf">combineLatest</span><span class="p">:@[</span> <span class="n">RACAbleWithStart</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">displayingDate</span><span class="p">),</span> <span class="n">RACAbleWithStart</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">earliestScrobbleDate</span><span class="p">),</span> <span class="n">RACAbleWithStart</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">latestScrobbleDate</span><span class="p">)]</span> <span class="p">];</span>
    
    <span class="c1">// Do it on the main thread
</span>    <span class="p">[</span><span class="n">combinedSignal</span> <span class="nf">deliverOn</span><span class="p">:[</span><span class="n">RACScheduler</span> <span class="nf">mainThreadScheduler</span><span class="p">]];</span>
    
    <span class="c1">// Actions to perform when changing any of the three signals
</span>    <span class="p">[</span><span class="n">combinedSignal</span> <span class="nf">subscribeNext</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">RACTuple</span> <span class="o">*</span><span class="n">dates</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">NSDate</span> <span class="o">*</span><span class="n">displayingDate</span> <span class="o">=</span> <span class="n">dates</span><span class="p">.</span><span class="n">first</span><span class="err">;</span>
         <span class="n">NSDate</span> <span class="o">*</span><span class="n">earliestScrobbleDate</span> <span class="o">=</span> <span class="n">dates</span><span class="p">.</span><span class="n">second</span><span class="err">;</span>
         <span class="n">NSDate</span> <span class="o">*</span><span class="n">latestScrobbleDate</span> <span class="o">=</span> <span class="n">dates</span><span class="p">.</span><span class="n">third</span><span class="err">;</span>
        <span class="err">@strongify</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">displayingDate</span><span class="p">){</span>
          <span class="c1">// Set the displaying date label
</span>          
          <span class="c1">// Calculate and set canMoveBackOneYear and canMoveForwardOneYear
</span>          
          <span class="c1">// Only show the left and right labels/arrows 
</span>          <span class="c1">// if there's data there to jump to.
</span>          
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
          <span class="c1">// There's no displaying date, so set all labels to nil
</span>        <span class="p">}</span>
        
     <span class="p">}];</span>
      
    <span class="c1">// …
</span>    
<span class="p">}</span></code></pre></figure>

<p>I’ve separated out the expressions again, and I’ve replaced a bunch of tedious date calculation code and view updating code with comments in order to focus on what’s happening with RAC. You can see everything in the source.</p>

<p>The slideSelectView has a couple components that depend on <code class="language-plaintext highlighter-rouge">displayingDate</code>, <code class="language-plaintext highlighter-rouge">earliestScrobbleDate</code>, and <code class="language-plaintext highlighter-rouge">latestScrobbleDate</code>. I want to update this view when any of these values change. Luckily, there’s an RACSignal constructor for this.</p>

<p><code class="language-plaintext highlighter-rouge">[RACSignal combineLatest:]</code> allows you to combine several signals into one signal. The new signal sends a <code class="language-plaintext highlighter-rouge">next:</code> message any time one of its component signals sends <code class="language-plaintext highlighter-rouge">next:</code>. There are a few variations of <code class="language-plaintext highlighter-rouge">combineLatest:</code> but the one we’ll use in this example will combine all the latest <code class="language-plaintext highlighter-rouge">next:</code> values of our three component signals into a single <a href="https://github.com/ReactiveCocoa/ReactiveCocoa/blob/master/ReactiveCocoaFramework/ReactiveCocoa/RACTuple.h">RACTuple</a> object. If you haven’t heard of a tuple before, you can think of it like an array for now.</p>

<p><code class="language-plaintext highlighter-rouge">combineLatest</code> takes an array of signals, which we’ll generate on-the-fly with <code class="language-plaintext highlighter-rouge">RACAbleWithStart</code>.</p>

<p>When we subscribe, we expect a single <code class="language-plaintext highlighter-rouge">RACTuple</code> object to be delivered with the latest values of our component signals in the order we placed them in the original array. We can use the <code class="language-plaintext highlighter-rouge">RACTuple</code> helper methods <code class="language-plaintext highlighter-rouge">.first</code>, <code class="language-plaintext highlighter-rouge">.second</code>, etc. to break out the values we need.</p>

<p>Within the block, we calculate some booleans and set some labels. This could be broken up into multiple methods, but in this case, it made the most sense to do these calculations and assignments in the same place because they depend on the same set of signals.</p>

<p>Let’s do one more view-related signal to show how primitive values are handled.</p>

<blockquote>
  <p>(TCSWeeklyAlbumChartViewController.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">setUpViewSignals</span><span class="p">{</span>
    <span class="err">@weakify</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

    <span class="c1">// …
</span>    
    <span class="c1">// Show or hide the loading view
</span>    <span class="p">[[[</span><span class="n">RACAble</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">showingLoading</span><span class="p">)</span> <span class="nf">distinctUntilChanged</span><span class="p">]</span> 
     <span class="nf">deliverOn</span><span class="p">:[</span><span class="n">RACScheduler</span> <span class="nf">mainThreadScheduler</span><span class="p">]]</span>
     <span class="nf">subscribeNext</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="n">showingLoading</span><span class="p">)</span> <span class="p">{</span>
      <span class="err">@strongify</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">;</span>
      <span class="n">BOOL</span> <span class="n">isShowingLoading</span> <span class="o">=</span> <span class="p">[</span><span class="n">showingLoading</span> <span class="nf">boolValue</span><span class="p">]</span><span class="err">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">isShowingLoading</span><span class="p">){</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">loadingImageView</span> <span class="nf">startAnimating</span><span class="p">]</span><span class="err">;</span>
        <span class="n">self</span><span class="p">.</span><span class="n">loadingImageView</span><span class="p">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="nb">NO</span><span class="err">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">loadingImageView</span> <span class="nf">stopAnimating</span><span class="p">]</span><span class="err">;</span>
        <span class="n">self</span><span class="p">.</span><span class="n">loadingImageView</span><span class="p">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="nb">YES</span><span class="err">;</span>
      <span class="p">}</span>
    <span class="p">}];</span>
    
    <span class="err">…</span>
    
<span class="p">}</span></code></pre></figure>

<p>Here we’re observing the <code class="language-plaintext highlighter-rouge">showingLoading</code> state variable. This variable will presumably be set by the data subscribers when they’re about to do something with the network or process data.</p>

<p>This time I left the signal creation, modification, and subscription all in one call.</p>

<p><code class="language-plaintext highlighter-rouge">RACAble(self.showingLoading)</code> creates the signal. <code class="language-plaintext highlighter-rouge">distinctUntilChanged</code> modifies the signal to only send a <code class="language-plaintext highlighter-rouge">next:</code> value to subscribers when that value is different from the last one. For example, let’s assume <code class="language-plaintext highlighter-rouge">showingLoading</code> is <code class="language-plaintext highlighter-rouge">YES</code>. If somewhere in our controller, a method sets <code class="language-plaintext highlighter-rouge">showingLoading</code> to <code class="language-plaintext highlighter-rouge">NO</code>, then it is also set to <code class="language-plaintext highlighter-rouge">NO</code> later, the <code class="language-plaintext highlighter-rouge">subscribeNext:</code> block will only be executed on the first change from <code class="language-plaintext highlighter-rouge">YES</code> to <code class="language-plaintext highlighter-rouge">NO</code>.</p>

<p>We’ve seen <code class="language-plaintext highlighter-rouge">deliverOn:</code> a few times now. No surprises there.</p>

<p>Now for the subscription. You can see that the <code class="language-plaintext highlighter-rouge">next:</code> value is delivered as an <code class="language-plaintext highlighter-rouge">NSNumber</code> object even though <code class="language-plaintext highlighter-rouge">self.showingLoading</code> is a primitive <code class="language-plaintext highlighter-rouge">BOOL</code>. RAC will wrap primitives and structs in objects for us. So before we compare against the value, I’ll use <code class="language-plaintext highlighter-rouge">[showingLoading boolValue]</code> to get the primitive back.</p>

<p>You can check out the rest of the view signals and subscriptions in the source.</p>

<h5 id="setupdatasignals">setUpDataSignals</h5>

<p>We’ll introduce a couple new RAC concepts in this method. But first, here’s an ugly ascii variable dependency graph. We’ll use this to set up our signals.</p>

<div class="language-plaintext highlighter-rouge"><pre class="highlight"><code>    userName            now         displayingYearsAgo
        |                \              /
    lastFMClient          displayingDate
        |                       /
    weeklyCharts              /
        \                   /
        displayingWeeklyChart
                |
        rawAlbumChartsForWeek
                |
        albumChartsForWeek
                |
        [tableView reloadData]
</code></pre>
</div>

<p>When any of these variables change, they trigger a change upstream (downstream?) to the variables that depend on them.</p>

<p>For example, if the user changes <code class="language-plaintext highlighter-rouge">displayingDate</code> (moving to a past year), a change will be triggered in <code class="language-plaintext highlighter-rouge">displayingWeeklyChart</code>, which will trigger a change in <code class="language-plaintext highlighter-rouge">rawAlbumChartsForWeek</code> and so on. If our data was more time sensitive (by-the-minute instead of by-the-week), we could set up a signal for <code class="language-plaintext highlighter-rouge">now</code> that would trigger a change down the line every minute. Or if we decided to reuse our controller with different users, a <code class="language-plaintext highlighter-rouge">userName</code> change would trigger a change down the line.</p>

<p>We’ll start with the userName observer.</p>

<blockquote>
  <p>(TCSWeeklyAlbumChartViewController.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="c1">// All the signals that deal with acquiring and reacting to data changes
</span><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">setUpDataSignals</span><span class="p">{</span>

  <span class="err">@weakify</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

  <span class="c1">// Setting the username triggers loading of the lastFMClient
</span>  <span class="p">[[</span><span class="n">RACAbleWithStart</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">userName</span><span class="p">)</span> <span class="nf">filter</span><span class="p">:</span><span class="o">^</span><span class="n">BOOL</span><span class="p">(</span><span class="n">id</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span><span class="err">;</span>
  <span class="p">}]</span> <span class="nf">subscribeNext</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">userName</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Loading client for %@..."</span><span class="p">,</span> <span class="n">userName</span><span class="p">)</span><span class="err">;</span>
    <span class="err">@strongify</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">lastFMClient</span> <span class="o">=</span> <span class="p">[</span><span class="n">TCSLastFMAPIClient</span> <span class="nf">clientForUserName</span><span class="p">:</span><span class="n">userName</span><span class="p">]</span><span class="err">;</span>
  <span class="p">}];</span>
  
  <span class="c1">// …
</span>  
<span class="p">}</span></code></pre></figure>

<p>We’ve seen the <code class="language-plaintext highlighter-rouge">RACAbleWithStart</code> pattern. We’re going to use <code class="language-plaintext highlighter-rouge">filter:</code> to act only on non-nil values of <code class="language-plaintext highlighter-rouge">userName</code>. Filter takes a block with an argument of the same type as is sent in <code class="language-plaintext highlighter-rouge">next:</code>. In this case, we don’t need to cast it directly, we just know it shouldn’t be nil. <code class="language-plaintext highlighter-rouge">filter</code>’s block returns a <code class="language-plaintext highlighter-rouge">BOOL</code> that indicates whether it should pass the <code class="language-plaintext highlighter-rouge">next</code> value to subscribers. Returning <code class="language-plaintext highlighter-rouge">YES</code> passes the value. Returning <code class="language-plaintext highlighter-rouge">NO</code> blocks it and the <code class="language-plaintext highlighter-rouge">subscribeNext</code> block will never see it. <code class="language-plaintext highlighter-rouge">filter</code> is a operation defined by <code class="language-plaintext highlighter-rouge">RACStream</code> like <code class="language-plaintext highlighter-rouge">map</code> which we saw earlier.</p>

<p>Next is another RAC pattern. You can automatically assign a property to the latest <code class="language-plaintext highlighter-rouge">next</code> value sent by a signal by using <code class="language-plaintext highlighter-rouge">RAC(my_property) = my_signal</code>. There are actually a couple other ways to accomplish this too. Here’s an example from Vinylogue.</p>

<blockquote>
  <p>(TCSWeeklyAlbumChartViewController.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">setUpDataSignals</span><span class="p">{</span>

  <span class="err">@weakify</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

  <span class="c1">// …
</span>  
  <span class="c1">// Update the date being displayed based on the current date/time and how many years ago we want to go back
</span>  <span class="n">RAC</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">displayingDate</span><span class="p">)</span> <span class="o">=</span> <span class="p">[[[[</span><span class="n">RACSignal</span> <span class="nf">combineLatest</span><span class="p">:@[</span> <span class="n">RACAble</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">now</span><span class="p">),</span> <span class="n">RACAble</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">displayingYearsAgo</span><span class="p">)</span> <span class="p">]]</span>
    <span class="nf">deliverOn</span><span class="p">:[</span><span class="n">RACScheduler</span> <span class="nf">scheduler</span><span class="p">]]</span>
    <span class="nf">map</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">RACTuple</span> <span class="o">*</span><span class="n">t</span><span class="p">){</span>
      <span class="n">NSDate</span> <span class="o">*</span><span class="n">now</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">first</span><span class="err">;</span>
      <span class="n">NSNumber</span> <span class="o">*</span><span class="n">displayingYearsAgo</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">second</span><span class="err">;</span>
      <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Calculating time range for %@ year(s) ago..."</span><span class="p">,</span> <span class="n">displayingYearsAgo</span><span class="p">)</span><span class="err">;</span>
      <span class="n">NSDateComponents</span> <span class="o">*</span><span class="n">components</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSDateComponents</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">]</span><span class="err">;</span>
      <span class="n">components</span><span class="p">.</span><span class="n">year</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">[</span><span class="n">displayingYearsAgo</span> <span class="nf">integerValue</span><span class="p">]</span><span class="err">;</span>
      <span class="k">return</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">calendar</span> <span class="nf">dateByAddingComponents</span><span class="p">:</span><span class="n">components</span> <span class="nf">toDate</span><span class="p">:</span><span class="n">now</span> <span class="nf">options</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span><span class="err">;</span>
    <span class="p">}]</span> <span class="nf">filter</span><span class="p">:</span><span class="o">^</span><span class="n">BOOL</span><span class="p">(</span><span class="n">id</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Time range calculated"</span><span class="p">)</span><span class="err">;</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span><span class="err">;</span>
    <span class="p">}];</span>
  
  <span class="err">…</span>
  
<span class="p">}</span></code></pre></figure>

<p>This one is a little tricky so let’s step through it. First thing we’re doing is setting up the <code class="language-plaintext highlighter-rouge">RAC(property)</code> assignment. <code class="language-plaintext highlighter-rouge">self.displayingDate</code> will be assigned to whatever <code class="language-plaintext highlighter-rouge">next</code> value comes out of our complicated signal on the other side of the equals sign.</p>

<p>We’re creating a signal that combines our <code class="language-plaintext highlighter-rouge">self.now</code> and <code class="language-plaintext highlighter-rouge">self.displayingYearsAgo</code> signalified properties. Remember, they’re not just regular properties. We’ve made them into signals by wrapping them with <code class="language-plaintext highlighter-rouge">RACAble</code>, and they send their values each time they’re changed.</p>

<p>We’re injecting a <code class="language-plaintext highlighter-rouge">deliverOn</code> with the default background scheduler <code class="language-plaintext highlighter-rouge">[RACScheduler scheduler]</code> before doing any work on the next values to make sure the work will be done off the main thread (ensuring a snappy UI).</p>

<p>Edit: Doing this on a background thread is probably overkill and most likely not the best idea since we’re now changing controller properties off the main thread.</p>

<p>Remember that <code class="language-plaintext highlighter-rouge">combineLatest</code> creates an <code class="language-plaintext highlighter-rouge">RACTuple</code> with the <code class="language-plaintext highlighter-rouge">next</code> values of each signal it wraps. We break that tuple out into an <code class="language-plaintext highlighter-rouge">NSDate</code> and an <code class="language-plaintext highlighter-rouge">NSNumber</code> and use those to calculate a date in the past. Remember that <code class="language-plaintext highlighter-rouge">map</code> just modifies <code class="language-plaintext highlighter-rouge">next</code> values. It has to return a value to pass to subscribers. It doesn’t have to be the same type; our input is an <code class="language-plaintext highlighter-rouge">RACTuple</code> and our output is an <code class="language-plaintext highlighter-rouge">NSDate</code> in this case.</p>

<p>Our last operation is a filter for nil. It’s useless to assign nil to our displayingDate. If this returns <code class="language-plaintext highlighter-rouge">YES</code>, then our <code class="language-plaintext highlighter-rouge">next</code> date returned from <code class="language-plaintext highlighter-rouge">map</code> will automatically be assigned to <code class="language-plaintext highlighter-rouge">self.displayingDate</code>.</p>

<p>We’ll do one expression in order to show how we use the Last.fm client functions we wrote earlier.</p>

<blockquote>
  <p>(TCSWeeklyAlbumChartViewController.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">setUpDataSignals</span><span class="p">{</span>

  <span class="err">@weakify</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

  <span class="err">…</span>
  
 <span class="c1">// When the weeklychart changes (being loaded the first time, 
</span> <span class="c1">// or the display date changed), fetch the list of albums for that time period.
</span> <span class="p">[[[</span><span class="n">RACAble</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">displayingWeeklyChart</span><span class="p">)</span> <span class="nf">filter</span><span class="p">:</span><span class="o">^</span><span class="n">BOOL</span><span class="p">(</span><span class="n">id</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span><span class="err">;</span>
 <span class="p">}]</span> <span class="nf">deliverOn</span><span class="p">:[</span><span class="n">RACScheduler</span> <span class="nf">scheduler</span><span class="p">]]</span>
  <span class="nf">subscribeNext</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">WeeklyChart</span> <span class="o">*</span><span class="n">displayingWeeklyChart</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Loading album charts for the selected week..."</span><span class="p">)</span><span class="err">;</span>
    <span class="err">@strongify</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">;</span>
    <span class="p">[[[</span><span class="n">self</span><span class="p">.</span><span class="n">lastFMClient</span> <span class="nf">fetchWeeklyAlbumChartForChart</span><span class="p">:</span><span class="n">displayingWeeklyChart</span><span class="p">]</span>
      <span class="nf">deliverOn</span><span class="p">:[</span><span class="n">RACScheduler</span> <span class="nf">scheduler</span><span class="p">]]</span>
     <span class="nf">subscribeNext</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="n">albumChartsForWeek</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">NSLog</span><span class="p">(</span><span class="s">@"Copying raw weekly charts..."</span><span class="p">)</span><span class="err">;</span>
       <span class="err">@strongify</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">;</span>
       <span class="n">self</span><span class="p">.</span><span class="n">rawAlbumChartsForWeek</span> <span class="o">=</span> <span class="n">albumChartsForWeek</span><span class="err">;</span>
     <span class="p">}</span> <span class="nf">error</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
       <span class="err">@strongify</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">;</span>
       <span class="n">self</span><span class="p">.</span><span class="n">albumChartsForWeek</span> <span class="o">=</span> <span class="nb">nil</span><span class="err">;</span>
       <span class="n">NSLog</span><span class="p">(</span><span class="s">@"There was an error fetching the weekly album charts!"</span><span class="p">)</span><span class="err">;</span>
       <span class="n">self</span><span class="p">.</span><span class="n">showingErrorMessage</span> <span class="o">=</span> <span class="n">error</span><span class="p">.</span><span class="n">localizedDescription</span><span class="err">;</span>
       <span class="n">self</span><span class="p">.</span><span class="n">showingError</span> <span class="o">=</span> <span class="nb">YES</span><span class="err">;</span>
     <span class="p">}]</span><span class="err">;</span>
  <span class="p">}];</span>
  
  <span class="c1">// …
</span>
<span class="p">}</span></code></pre></figure>

<p>Once we have a specific time period to request charts for, we’ll get a signal from the client by supplying the displayingWeeklyChart. We have a signal within a signal in this block. As soon as we <code class="language-plaintext highlighter-rouge">subscribeNext</code> to the signal that was returned from the client, it will request data from the network and do the processing.</p>

<p>We also subscribed with an error block this time so we can pass the error along to the user. By setting <code class="language-plaintext highlighter-rouge">showingError</code> and <code class="language-plaintext highlighter-rouge">showingErrorMessage</code>, the view signal subscriptions we created earlier are triggered. Remember that in this subscription, we’re still on a background thread. Changing these properties on a background thread will still trigger the view updates on the main thread. Pretty cool.</p>

<p>The rest of our <code class="language-plaintext highlighter-rouge">setUpDataSignals</code> method uses similar tricks with RAC, observing properties as outlined in our simple ascii chart. Check out the source to decipher the rest.</p>

<p>You should be at the point now where you can start picking through the signal operations in <a href="https://github.com/ReactiveCocoa/ReactiveCocoa/blob/master/ReactiveCocoaFramework/ReactiveCocoa/RACSignal%2BOperations.h">RACSignal+Operations.h</a>. <a href="https://github.com/ReactiveCocoa/ReactiveCocoa/blob/master/ReactiveCocoaFramework/ReactiveCocoa/RACStream.h">RACStream.h</a> also has some operations you should be aware of.</p>

<p>In the next section we’ll also briefly cover <code class="language-plaintext highlighter-rouge">RACCommand</code>s.</p>

<h3 id="tcsslideselectview">TCSSlideSelectView</h3>

<p>The slideSelectView is the extra special control we dreamed up earlier in the wireframing section.</p>

<div class="caption-wrapper"><img class="caption" src="/images/vinylogue-slideselectview.jpg" width="" height="" alt="Reminder of slideSelectView" title="Reminder of slideSelectView" /><div class="caption-text">Reminder of slideSelectView</div></div>

<p>We should break it out so we know how we should code the view hierarchy.</p>

<div class="caption-wrapper"><img class="caption" src="/images/vinylogue-slideselectviewbreakout.jpg" width="" height="" alt="slideSelectView broken out" title="slideSelectView broken out" /><div class="caption-text">slideSelectView broken out</div></div>

<p>Let’s implement it!</p>

<h4 id="interface-1">Interface</h4>

<p>From our sketch, we can deconstruct the views we need.</p>

<blockquote>
  <p>(TCSSlideSelectView.h)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">@interface</span> <span class="nc">TCSSlideSelectView</span> <span class="p">:</span> <span class="nc">UIView</span> <span class="o">&lt;</span><span class="n">UIScrollViewDelegate</span><span class="o">&gt;</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">UIView</span> <span class="o">*</span><span class="n">backView</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">UIButton</span> <span class="o">*</span><span class="n">backLeftButton</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">UIButton</span> <span class="o">*</span><span class="n">backRightButton</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">UILabel</span> <span class="o">*</span><span class="n">backLeftLabel</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">UILabel</span> <span class="o">*</span><span class="n">backRightLabel</span><span class="p">;</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">UIScrollView</span> <span class="o">*</span><span class="n">scrollView</span><span class="p">;</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">UIView</span> <span class="o">*</span><span class="n">frontView</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">UILabel</span> <span class="o">*</span><span class="n">topLabel</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="n">UILabel</span> <span class="o">*</span><span class="n">bottomLabel</span><span class="p">;</span>

<span class="c1">// Signals will be fired when the scroll view is dragged past the offset
</span><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">)</span> <span class="n">CGFloat</span> <span class="n">pullLeftOffset</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">)</span> <span class="n">CGFloat</span> <span class="n">pullRightOffset</span><span class="p">;</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">RACCommand</span> <span class="o">*</span><span class="n">pullLeftCommand</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">RACCommand</span> <span class="o">*</span><span class="n">pullRightCommand</span><span class="p">;</span>

<span class="k">@end</span></code></pre></figure>

<p>We’ll decide up front that this view will be somewhere between a generic and concrete view. A good future exercise would be figuring out how to make this view generic enough to be used by other controllers and apps. We’ve made it sort of generic by exposing all the subviews as readonly, therefore allowing other objects to change view colors and other properties, but not allowing them to replace views with their own.</p>

<p>We’ll actually redefine these view properties in the private interface in the implementation file.</p>

<p>Although our view will have defaults for the pull offsets and commands, we’ll allow outside classes to change or replace them at will.</p>

<p>The pull offsets are values that answer the question, “How far do I have to pull the scroll view to the right or left before an action is triggered?” The commands are <code class="language-plaintext highlighter-rouge">RACSignal</code> subclasses that are designed to send <code class="language-plaintext highlighter-rouge">next</code> values triggered off of an action, usually from the UI. We’ll use these constructs instead of the delegate pattern to pass messages from our custom view to the controller that owns it.</p>

<h4 id="implementation">Implementation</h4>

<p>Here’s the private interface:</p>

<blockquote>
  <p>(TCSSlideSelectView.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">@interface</span> <span class="nc">TCSSlideSelectView</span> <span class="p">()</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">UIView</span> <span class="o">*</span><span class="n">backView</span><span class="p">;</span>
<span class="c1">// redefine the rest of the views as strong instead of readonly
// ...
</span>
<span class="k">@end</span></code></pre></figure>

<p>We’ll define the view hierarchy and create defaults in <code class="language-plaintext highlighter-rouge">init</code>.</p>

<blockquote>
  <p>(TCSSlideSelectView.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">init</span><span class="p">{</span>
  <span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="nf">initWithFrame</span><span class="p">:</span><span class="n">CGRectZero</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">backView</span><span class="p">];</span>
    
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">backView</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">backLeftLabel</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">backView</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">backRightLabel</span><span class="p">];</span>
    
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">backView</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">scrollView</span><span class="p">];</span>
    
    <span class="c1">// Buttons technically sit above (but not on) 
</span>    <span class="c1">// the scrollview in order to intercept touches
</span>    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">backView</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">backLeftButton</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">backView</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">backRightButton</span><span class="p">];</span>
    
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">scrollView</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">frontView</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">frontView</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">topLabel</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">frontView</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">bottomLabel</span><span class="p">];</span>
    
    <span class="c1">// Set up commands
</span>    <span class="n">self</span><span class="p">.</span><span class="n">pullLeftOffset</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">pullRightOffset</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">pullLeftCommand</span> <span class="o">=</span> <span class="p">[</span><span class="n">RACCommand</span> <span class="nf">command</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">pullRightCommand</span> <span class="o">=</span> <span class="p">[</span><span class="n">RACCommand</span> <span class="nf">command</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Logically, the buttons would be behind the scrollView, but I was having trouble getting taps to get forwarded from the invisible scrollview to the button below it (maybe I should have just made the scrollView narrower?). Instead, the buttons sit above the scrollview and disappear when scrolling begins.</p>

<p>We also define defaults for the pull offsets and set up generic <code class="language-plaintext highlighter-rouge">RACCommand</code>s.</p>

<p>I use <code class="language-plaintext highlighter-rouge">layoutSubviews</code> to resize the views and lay them out. This is mostly self explanatory and tedious to explain. Feel free to read the source to see how I do that.</p>

<p>We’ll move on to the more interesting part: using <code class="language-plaintext highlighter-rouge">RACCommand</code>s to pass messages.</p>

<blockquote>
  <p>(TCSSlideSelectView.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="cp"># pragma mark - UIScrollViewDelegate
</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">scrollViewWillBeginDragging</span><span class="p">:(</span><span class="n">UIScrollView</span> <span class="o">*</span><span class="p">)</span><span class="nv">scrollView</span><span class="p">{</span>
  <span class="p">[</span><span class="n">self</span> <span class="nf">showBackButtons</span><span class="p">:</span><span class="nb">NO</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">scrollViewDidEndDragging</span><span class="p">:(</span><span class="n">UIScrollView</span> <span class="o">*</span><span class="p">)</span><span class="nv">scrollView</span> <span class="nf">willDecelerate</span><span class="p">:(</span><span class="n">BOOL</span><span class="p">)</span><span class="nv">decelerate</span><span class="p">{</span>
  <span class="n">CGFloat</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">scrollView</span><span class="p">.</span><span class="n">contentOffset</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">self</span><span class="p">.</span><span class="n">pullLeftOffset</span><span class="p">){</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">pullLeftCommand</span> <span class="nf">execute</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
  <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">self</span><span class="p">.</span><span class="n">pullRightOffset</span><span class="p">){</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">pullRightCommand</span> <span class="nf">execute</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="p">[</span><span class="n">self</span> <span class="nf">showBackButtons</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
<span class="p">}</span></code></pre></figure>

<p>Like I just mentioned before, we’ll hide the buttons when scrolling starts and show them again when scrolling ends.</p>

<p>When scrolling ends, we check the x offset of the scrollview. If it’s past the offsets that were set earlier, we use the <code class="language-plaintext highlighter-rouge">execute</code> method of the <code class="language-plaintext highlighter-rouge">RACCommand</code>. An <code class="language-plaintext highlighter-rouge">RACCommand</code> is just a subclass of an <code class="language-plaintext highlighter-rouge">RACSignal</code> with a few behavior modifications. <code class="language-plaintext highlighter-rouge">execute:</code> sends its argument in a <code class="language-plaintext highlighter-rouge">next</code> message to subscribers. In our example, we don’t need to send any particular object, just the message is enough. We could have alternatively only had one command object and sent the direction as the message object. That’s a little confusing though.</p>

<p>This design pattern works for a few reasons. If the command has no subscribers, the message will be ignored, no harm done. So far though, it isn’t really that much different than creating a protocol and holding a reference to a delegate. I’ll show you the interesting part in a second.</p>

<p>Before we move back to the controller to show how we handle these messages, here’s how we handle the buttons:</p>

<blockquote>
  <p>(TCSSlideSelectView.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="cp"># pragma mark - private
</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">doLeftButton</span><span class="p">:(</span><span class="n">UIButton</span> <span class="o">*</span><span class="p">)</span><span class="nv">button</span><span class="p">{</span>
  <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">pullLeftCommand</span> <span class="nf">execute</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">doRightButton</span><span class="p">:(</span><span class="n">UIButton</span> <span class="o">*</span><span class="p">)</span><span class="nv">button</span><span class="p">{</span>
  <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">pullRightCommand</span> <span class="nf">execute</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">}</span></code></pre></figure>

<p>The buttons trigger the same action as the scrollView.</p>

<p>Another way to interface <code class="language-plaintext highlighter-rouge">UIControl</code>s with RAC is to use the <code class="language-plaintext highlighter-rouge">RACSignalSupport</code> category:</p>

<blockquote>
  <p>(UIControl+RACSignalSupport.h)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">@interface</span> <span class="nc">UIControl</span> <span class="p">(</span><span class="nl">RACSignalSupport</span><span class="p">)</span>

<span class="c1">// Creates and returns a signal that sends the sender of the control event
// whenever one of the control events is triggered.
</span><span class="err">-</span> <span class="err">(</span><span class="nc">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="n">rac_signalForControlEvents</span><span class="o">:</span><span class="p">(</span><span class="n">UIControlEvents</span><span class="p">)</span><span class="n">controlEvents</span><span class="p">;</span>

<span class="k">@end</span></code></pre></figure>

<p>Let’s quickly jump back to the <code class="language-plaintext highlighter-rouge">TCSWeeklyAlbumChartViewController</code> to show how we interface with this custom control.</p>

<blockquote>
  <p>(TCSWeeklyAlbumChartViewController.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">setUpDataSignals</span><span class="p">{</span>

  <span class="c1">// …
</span>  
  <span class="c1">// Change displayed year by sliding the slideSelectView left or right
</span>  <span class="n">self</span><span class="p">.</span><span class="n">slideSelectView</span><span class="p">.</span><span class="n">pullLeftCommand</span> <span class="o">=</span> <span class="p">[</span><span class="n">RACCommand</span> <span class="nf">commandWithCanExecuteSignal</span><span class="p">:</span><span class="n">RACAble</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">canMoveBackOneYear</span><span class="p">)];</span>
  <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">slideSelectView</span><span class="p">.</span><span class="n">pullLeftCommand</span> <span class="nf">subscribeNext</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">id</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="err">@strongify</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">displayingYearsAgo</span> <span class="o">+=</span> <span class="mi">1</span><span class="err">;</span>
  <span class="p">}];</span>
  <span class="n">self</span><span class="p">.</span><span class="n">slideSelectView</span><span class="p">.</span><span class="n">pullRightCommand</span> <span class="o">=</span> <span class="p">[</span><span class="n">RACCommand</span> <span class="nf">commandWithCanExecuteSignal</span><span class="p">:</span><span class="n">RACAble</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">canMoveForwardOneYear</span><span class="p">)];</span>
  <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">slideSelectView</span><span class="p">.</span><span class="n">pullRightCommand</span> <span class="nf">subscribeNext</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">id</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="err">@strongify</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">displayingYearsAgo</span> <span class="o">-=</span> <span class="mi">1</span><span class="err">;</span>
  <span class="p">}];</span>
  
  <span class="c1">// …
</span>  
<span class="p">}</span></code></pre></figure>

<p>We’re creating signals (commands) and assigning them to the slideSelectView. The slideSelectView will own these signals, but before the controller hands them over, it will add a special “canExecuteSignal” and then subscription instructions for each.</p>

<p>The command will check the latest value of its canExecute signal (which should be a <code class="language-plaintext highlighter-rouge">BOOL</code>) to decide whether it should fire before executing its <code class="language-plaintext highlighter-rouge">next</code> block. In the example, we don’t want to let the user move to the past unless there are weeks to show there. We create a signal from our <code class="language-plaintext highlighter-rouge">BOOL</code> property <code class="language-plaintext highlighter-rouge">canMoveBackOneYear</code> and assign it to the command. Our <code class="language-plaintext highlighter-rouge">canMove</code> properties will now govern the actions of the slideSelectView for us.</p>

<p>When these commands are allowed to fire, they’ll update our <code class="language-plaintext highlighter-rouge">displayingYearsAgo</code> property, and the changes will propagate through our ascii dependency chart.</p>

<p>That’s about it for the slideSelectView. Now that we have the skeleton of our app created, time to start thinking about the design.</p>

<h2 id="design"><a href="id:design">Design</a></h2>

<p>Alright, so we’ve now done a fair amount of development. There’s at least enough for a prototype using built in controls. Now it’s time to get a feel for how everything is going to look.</p>

<p>This is approximately what our app looks like at this point:</p>

<div class="caption-wrapper"><img class="caption" src="/images/vinylogue-uglyprototype.png" width="" height="" alt="Ugly working prototype" title="Ugly working prototype" /><div class="caption-text">Ugly working prototype</div></div>

<p><em>I am not a designer</em>. I usually work with my friend CJ from <a href="http://oltmandesign.com">Oltman Design</a>, but since this was a low-stakes, unpaid project with a tight-timeline, I decided to give it a shot myself.</p>

<p>Many shops will complete the wireframes, UX, and then do the Photoshop mockups before even involving the developers. Since I’m doing everything, I sometimes pivot back and forth between the two, using new ideas while doing each to iterate in both directions.</p>

<p>You can also see that from my ugly prototype screen shot that I like to multicolor my views initially to make sure everything is being laid out as expected.</p>

<h3 id="photoshop">Photoshop</h3>

<p>I took my ugly mockup and threw it into photoshop, then styled on top of it. I wanted to start with a more colorful mockup and used this <a href="http://color.hailpixel.com">color picker</a> to pick out a bunch of colors I liked (again, <em>not a designer!</em>).</p>

<p>Here is my first mock up:</p>

<div class="caption-wrapper"><img class="caption" src="/images/vinylogue-firstmockup.png" width="" height="" alt="First mock up" title="First mock up" /><div class="caption-text">First mock up</div></div>

<p>I chose iOS6’s new Avenir Next font in a few weights because it’s pretty, a little more unique, but still very readable and not too opinionated.</p>

<p>As a non-designer, I simply asked myself what the relative order of importance for each element was, and adjusted its relative color and size accordingly. The artist name is not as important as the album name, therefore the artist name is smaller and has less contrast. The album cover is important, so it is nice and big and the first thing you see on the left side (also a standard iOS design pattern). I added padding to the album images so they wouldn’t bump up against each other on the top and bottom, which sometimes looks weird. The number of plays is big and stands out, while the word “plays” can be inferred after seeing it the first time, and can therefore be downplayed heavily. I gave the cells a classic one-line top highlight and bottom shadow.</p>

<p>For my slide control, I wanted to give it depth to imply it being stacked. A darker color and inner shadow accomplished this (although I’ve found Photoshop-style inner shadows much harder to implement with Core Animation and Core Graphics). The user name is mostly understood and is only there as a reminder, so it can be downplayed. The week is important so it should stand out.</p>

<p>I was originally planning on this being the only controller, so I put the logo top and center. The logo is just our normal Avenir Next font with a little extra tracking (not a designer). It looks just hipstery enough I think.</p>

<h3 id="code-the-cell-design">Code the cell design</h3>

<p>Now that there’s a map for our cell layout, let’s implement it.</p>

<h4 id="interface-2">Interface</h4>

<blockquote>
  <p>(TCSAlbumArtistPlayCountCell.h)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">@interface</span> <span class="nc">TCSAlbumArtistPlayCountCell</span> <span class="p">:</span> <span class="nc">UITableViewCell</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">WeeklyAlbumChart</span> <span class="o">*</span><span class="n">object</span><span class="p">;</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">refreshImage</span><span class="p">;</span>

<span class="k">+</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="nf">heightForObject</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">object</span> <span class="nf">atIndexPath</span><span class="p">:(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span> <span class="nf">tableView</span><span class="p">:(</span><span class="n">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="nv">tableView</span><span class="p">;</span>

<span class="k">@end</span></code></pre></figure>

<p>We’ll keep a reference to the model object we’re displaying. There’s some debate about the best way to implement the model/view relationship. Sometimes I borrow the concept of a “decorator” object from Rails that owns the model object and transforms its values into something displayable. I decided to keep this app simple this time and have the cell assign its own view attributes directly from the model object. If we didn’t have a one-to-one relationship between views and model objects, I would definitely reconsider this.</p>

<p>Ignore <code class="language-plaintext highlighter-rouge">refreshImage</code> for now. That tackles a problem we’ll run into later.</p>

<p><code class="language-plaintext highlighter-rouge">heightForObject</code> is our class object that does a height calculation for an object before an instance of the cell is actually allocated. Part of the UITableView protocols is knowing the height of a cell before it is actually laid out. I have yet to figure out a good way to do this without doubling up on some layout calculation code, but alas I’ve gotten used to writing it.</p>

<h4 id="implementation-1">Implementation</h4>

<p>Our private instance variables:</p>

<blockquote>
  <p>(TCSAlbumArtistPlayCountCell.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">@interface</span> <span class="nc">TCSAlbumArtistPlayCountCell</span> <span class="p">()</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">UILabel</span> <span class="o">*</span><span class="n">playCountLabel</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">UILabel</span> <span class="o">*</span><span class="n">playCountTitleLabel</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">UILabel</span> <span class="o">*</span><span class="n">rankLabel</span><span class="p">;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">UIView</span> <span class="o">*</span><span class="n">backView</span><span class="p">;</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">imageURLCache</span><span class="p">;</span>

<span class="k">@end</span></code></pre></figure>

<p>I’m reusing <code class="language-plaintext highlighter-rouge">UITableViewCell</code>’s <code class="language-plaintext highlighter-rouge">textLabel</code> and <code class="language-plaintext highlighter-rouge">detailTextLabel</code> for my artist and album labels, and reusing the <code class="language-plaintext highlighter-rouge">imageView</code> for the album image. Our cells aren’t currently selectable, so the cell only has a normal background view and not a selected one.</p>

<p>I’ll come back to that <code class="language-plaintext highlighter-rouge">imageURLCache</code> string in a moment.</p>

<blockquote>
  <p>(TCSAlbumArtistPlayCountCell.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">@implementation</span> <span class="nc">TCSAlbumArtistPlayCountCell</span>

<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">init</span><span class="p">{</span>
  <span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="nf">initWithStyle</span><span class="p">:</span><span class="n">UITableViewCellStyleSubtitle</span> <span class="nf">reuseIdentifier</span><span class="p">:</span><span class="n">NSStringFromClass</span><span class="p">([</span><span class="n">self</span> <span class="nf">class</span><span class="p">])];</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">self</span><span class="p">.</span><span class="n">selectionStyle</span> <span class="o">=</span> <span class="n">UITableViewCellSelectionStyleNone</span><span class="p">;</span>
    
    <span class="n">self</span><span class="p">.</span><span class="n">backgroundView</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">backView</span><span class="p">;</span>
        
    <span class="p">[</span><span class="n">self</span> <span class="nf">configureTextLabel</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">configureDetailTextLabel</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">configureImageView</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">contentView</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">playCountLabel</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">contentView</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">playCountTitleLabel</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">contentView</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">rankLabel</span><span class="p">];</span>
    
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// … 
</span>
<span class="k">@end</span></code></pre></figure>

<p>I create and/or configure my views in custom getters at the bottom of my implementation file. Nothing too interesting here. Moving on…</p>

<blockquote>
  <p>(TCSAlbumArtistPlayCountCell.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setObject</span><span class="p">:(</span><span class="n">WeeklyAlbumChart</span> <span class="o">*</span><span class="p">)</span><span class="nv">object</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">_object</span> <span class="o">==</span> <span class="n">object</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>
  
  <span class="n">_object</span> <span class="o">=</span> <span class="n">object</span><span class="p">;</span>
  <span class="n">self</span><span class="p">.</span><span class="n">textLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">object</span><span class="p">.</span><span class="n">artistName</span> <span class="nf">uppercaseString</span><span class="p">];</span>
  <span class="n">self</span><span class="p">.</span><span class="n">detailTextLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">object</span><span class="p">.</span><span class="n">albumName</span><span class="p">;</span>
  <span class="n">self</span><span class="p">.</span><span class="n">playCountLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">object</span><span class="p">.</span><span class="n">playcount</span> <span class="nf">stringValue</span><span class="p">];</span>
  <span class="n">self</span><span class="p">.</span><span class="n">rankLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">object</span><span class="p">.</span><span class="n">rank</span> <span class="nf">stringValue</span><span class="p">];</span>
  
  <span class="p">[</span><span class="n">self</span> <span class="nf">refreshImage</span><span class="p">];</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">object</span><span class="p">.</span><span class="n">playcountValue</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
    <span class="n">self</span><span class="p">.</span><span class="n">playCountTitleLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">NSLocalizedString</span><span class="p">(</span><span class="s">@"play"</span><span class="p">,</span> <span class="nb">nil</span><span class="p">);</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="n">self</span><span class="p">.</span><span class="n">playCountTitleLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">NSLocalizedString</span><span class="p">(</span><span class="s">@"plays"</span><span class="p">,</span> <span class="nb">nil</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Our custom object setter is in charge of properly assigning model object data to our views. The interesting problem we come across is the albumImage. Let’s look at the <code class="language-plaintext highlighter-rouge">refreshImage</code> instance method:</p>

<blockquote>
  <p>(TCSAlbumArtistPlayCountCell.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">refreshImage</span><span class="p">{</span>
  <span class="n">UIImage</span> <span class="o">*</span><span class="n">placeHolderImage</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span> <span class="nf">imageNamed</span><span class="p">:</span><span class="n">placeholderImage</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">imageView</span><span class="p">.</span><span class="n">image</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">){</span>
    <span class="n">self</span><span class="p">.</span><span class="n">imageView</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">placeHolderImage</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">albumImageURL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">albumImageURL</span> <span class="nf">isEqualToString</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">imageURLCache</span><span class="p">]){</span>
    <span class="c1">// prevent setting imageView unnecessarily
</span>    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">imageView</span> <span class="nf">setImageWithURL</span><span class="p">:[</span><span class="n">NSURL</span> <span class="nf">URLWithString</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">albumImageURL</span><span class="p">]</span> <span class="nf">placeholderImage</span><span class="p">:</span><span class="n">placeHolderImage</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">imageURLCache</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">object</span><span class="p">.</span><span class="n">albumImageURL</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>What do we know about the image at this point? When our WeeklyAlbumChart object is originally created, it does not have an album image URLl The Last.fm API does not return that data with the call we’re using. If we want that image URL, we have to request it using a separate <code class="language-plaintext highlighter-rouge">album.getInfo</code> API call. And it may not even exist for a particular album.</p>

<p>But getting that URL isn’t the cell’s responsibility. We don’t want to create or pass in a copy of the lastFMAPIClient to each cell. That seems like the controller/datasource’s responsibility.</p>

<p>Why don’t we just request all these image URLs when we originally receive the album chart list from the API client? We could, but if that list has 50+ albums in it, that’s 51+ API calls we just made. And if the user only scrolls through a couple, it’s a lot of wasted data. We should strive to do it more lazily. Only request the album image URL if the cell is actually being displayed. Luckily, we have a nice table view delegate method for that.</p>

<blockquote>
  <p>(TCSWeeklyAlbumChartViewController.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">tableView</span><span class="p">:(</span><span class="n">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="nv">tableView</span> <span class="nf">willDisplayCell</span><span class="p">:(</span><span class="n">UITableViewCell</span> <span class="o">*</span><span class="p">)</span><span class="nv">cell</span> <span class="nf">forRowAtIndexPath</span><span class="p">:(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span><span class="p">{</span>
  <span class="c1">// If the object doesn't have an album URL yet, request it from the server then refresh the cell
</span>  <span class="n">TCSAlbumArtistPlayCountCell</span> <span class="o">*</span><span class="n">albumCell</span> <span class="o">=</span> <span class="p">(</span><span class="n">TCSAlbumArtistPlayCountCell</span> <span class="o">*</span><span class="p">)</span><span class="n">cell</span><span class="p">;</span>
  <span class="n">WeeklyAlbumChart</span> <span class="o">*</span><span class="n">albumChart</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">albumChartsForWeek</span> <span class="nf">objectAtIndex</span><span class="p">:</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">albumChart</span><span class="p">.</span><span class="n">albumImageURL</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[[[</span><span class="n">self</span><span class="p">.</span><span class="n">lastFMClient</span> <span class="nf">fetchImageURLForWeeklyAlbumChart</span><span class="p">:</span><span class="n">albumChart</span><span class="p">]</span> <span class="nf">deliverOn</span><span class="p">:[</span><span class="n">RACScheduler</span> <span class="nf">mainThreadScheduler</span><span class="p">]]</span> <span class="nf">subscribeNext</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">albumImageURL</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">[</span><span class="n">albumCell</span> <span class="nf">refreshImage</span><span class="p">]</span><span class="err">;</span>
    <span class="p">}];</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>In the controller, if the model object does not have an albumImageURL we request it using a new API client method (that returns an <code class="language-plaintext highlighter-rouge">RACSignal</code> of course). We subscribe, so when it’s done we can refresh the cell and load the new image using <code class="language-plaintext highlighter-rouge">AFNetworking</code>’s <code class="language-plaintext highlighter-rouge">UIImageView</code> category that loads images asynchronously from a URL.</p>

<p>While we’re waiting for our response, the user could possibly have scrolled past the cell, and the cell could be reassigned a new object. No problems though, because <code class="language-plaintext highlighter-rouge">refreshImage</code> will just fall through without doing anything and the URL will be saved and loaded the next time the object is assigned to the cell.</p>

<p>The last thing we should do is clear out our <code class="language-plaintext highlighter-rouge">imageURLCache</code> in <code class="language-plaintext highlighter-rouge">prepareForReuse</code>, although technically everything will still work without doing so.</p>

<p>All of this work seems like exactly the thing that RAC would excel at. Unfortunately, I wrestled with several such implementations but could not get things to work out as I wanted. On my to-do list is to try again and see if something unrelated was the problem.</p>

<p>I was considering digging into the view layout calculations, but I think as was with the slideSelectView, explaining the layout code would be tedious and superfluous. Check it out in the source if you’re interested.</p>

<h3 id="photoshop-part-2">Photoshop part 2</h3>

<p>We coded up our cell layout and did the same for the slideSelectView and took a step back to see how it looks on the iPhone.</p>

<div class="caption-wrapper"><img class="caption" src="/images/vinylogue-codedlayout.png" width="" height="" alt="Coded layouts" title="Coded layouts" /><div class="caption-text">Coded layouts</div></div>

<p>Everything seems to be in the right place. Let’s go ahead and adjust fonts and colors, then tweak the layout to get things as close to our mock up as possible.</p>

<div class="caption-wrapper"><img class="caption" src="/images/vinylogue-codedlayoutfontscolors.png" width="" height="" alt="Set fonts and colors" title="Set fonts and colors" /><div class="caption-text">Set fonts and colors</div></div>

<p>Cool. Looking pretty close to what we had in photoshop. We haven’t gotten the inner shadows of the slideSelectView yet though. And the sharp rectangle of the slideSelectView’s top view doesn’t look particularly draggable. Let’s round off the corners. We’ll also add a button for opening up the settings (user name and play count, along with about info).</p>

<div class="caption-wrapper"><img class="caption" src="/images/vinylogue-codedlayouttweaks.png" width="" height="" alt="Some tweaks" title="Some tweaks" /><div class="caption-text">Some tweaks</div></div>

<h3 id="settings">Settings</h3>

<p>Next we need to create a settings controller and a controller for setting the user name.</p>

<p>I’m not going to go in depth for this one. I used a generic static table view datasource class I threw together for another project. You basically give it a specially coded dictionary with titles and optional selectors, then tell it what cell classes to use for headers and cells.</p>

<p>I didn’t do this one in photoshop first. Since it’s only one line of text per line, I simply coded it up and experimented a little with the fonts and colors I already had chosen.</p>

<div class="caption-wrapper"><img class="caption" src="/images/vinylogue-codedsettings.png" width="" height="" alt="First settings controller" title="First settings controller" /><div class="caption-text">First settings controller</div></div>

<p>I kept this theme going with the username input controller. I heavily borrowed the styling of the awesome and beautiful app <a href="http://eyedrop.me">EyeDrop.me</a>.</p>

<div class="caption-wrapper"><img class="caption" src="/images/vinylogue-usernamecontroller.png" width="" height="" alt="User name edit controller" title="User name edit controller" /><div class="caption-text">User name edit controller</div></div>

<h3 id="iteration">Iteration</h3>

<p>We now have a functional app! But now we can take a step back and really look at what’s going on.</p>

<ol>
  <li>The color scheme of the root controller is too much. The colors of the album art should draw the most focus not the background of the table cells nor the play count.</li>
  <li>The flow of the settings page kind of works, but it feels a little odd.</li>
  <li>My original thought was that this would be a one-user app, but during testing, I realized that:
    <ul>
      <li>We don’t need to input a user’s password to view their charts.</li>
      <li>During testing I was viewing my friends’ charts and enjoying perusing them.</li>
      <li>Why not just having a landing page controller where we can easily select charts for different users!?</li>
    </ul>
  </li>
</ol>

<p>It seems obvious in hindsight, but at the time it was anything but.</p>

<p>So let’s address each of these points.</p>

<ol>
  <li>I’m kind of liking the settings page. It was sort of an accident, but it’s minimalist, which is easier to pull off for someone with no sense of design. It’s also the way design trends have been going lately. Let’s aim for that on the root controller.</li>
  <li>We can probably address this along with #3.</li>
  <li>The root controller should be a list of users.
    <ul>
      <li>Selecting a user pushes their chart on the nav controller.</li>
      <li>Settings can be viewed and changed from the root controller.</li>
    </ul>
  </li>
</ol>

<div class="caption-wrapper"><img class="caption" src="/images/vinylogue-wireframe2.jpg" width="" height="" alt="Re-imagined wireframed controller flow" title="Re-imagined wireframed controller flow" /><div class="caption-text">Re-imagined wireframed controller flow</div></div>

<p>Awesome! A little more complicated, but overall a much more functional app.</p>

<h3 id="photoshop-part-3">Photoshop part 3</h3>

<p>Luckily all the layout is still winning our favor. All we have to do is tweak fonts and colors.</p>

<div class="caption-wrapper"><img class="caption" src="/images/vinylogue-mockup2.png" width="" height="" alt="Photoshop comp 2" title="Photoshop comp 2" /><div class="caption-text">Photoshop comp 2</div></div>

<p>That looks a lot cleaner. The slideSelectView looks a little weird, but we’ll play around with those colors on the device/simulator.</p>

<h3 id="design-implementation-part-2">Design implementation part 2</h3>

<div class="caption-wrapper"><img class="caption" src="/images/vinylogue-codedlayout2.png" width="" height="" alt="Redesign on the simulator" title="Redesign on the simulator" /><div class="caption-text">Redesign on the simulator</div></div>

<p>Yeah, much better.</p>

<p>Let’s check out the new users controller.</p>

<div class="caption-wrapper"><img class="caption" src="/images/vinylogue-usernamecontroller2.png" width="" height="" alt="Users controller" title="Users controller" /><div class="caption-text">Users controller</div></div>

<p>Looks good. UIKit automatically adds those table header view bottom borders and I can’t reliably get rid of them. Weird.</p>

<p>Because we’ve moved the primary user name out of settings, here’s the settings controller one more time.</p>

<div class="caption-wrapper"><img class="caption" src="/images/vinylogue-settings2.png" width="" height="" alt="Settings controller with no user name" title="Settings controller with no user name" /><div class="caption-text">Settings controller with no user name</div></div>

<h2 id="back-to-development"><a href="id:development2">Back to development</a></h2>

<p>Alright, we totally skipped the implementation of the users controller. Let’s touch on that and see if RAC has anything to do with it.</p>

<h3 id="data-store">Data store</h3>

<p>We have a new decision to make: how will we set/store users? We have a few options:</p>

<ol>
  <li>The user adds their friends’ user names manually.
    <ul>
      <li>Pros: simplest, may be what most users want.</li>
      <li>Cons: may be difficult for users to find/enter their friends’ usernames.</li>
    </ul>
  </li>
  <li>Automatically sync friends with last.fm.
    <ul>
      <li>Pros: users also might find this easiest.</li>
      <li>Cons: may be difficult to keep the user’s personal ordering.</li>
    </ul>
  </li>
  <li>Manually sync friends with last.fm on user request.
    <ul>
      <li>Pros: probably a good compromise as a “first run” option or default.</li>
      <li>Cons: users may get upset if they sync again and everything is overwritten.</li>
    </ul>
  </li>
</ol>

<p>We should probably start with option 1. Later we can add option 3 if the interest is there. Keep an ear open for option 2.</p>

<p>(Update: V1.1 has friend list importing, which solves these problems by only importing friends not already in the list).</p>

<p>The easiest way to implement option 1 is NSUserDefaults. We should probably wrap it in its own datastore class in order to abstract out the implementation details and make option 3 easier to add in the future.</p>

<p>Our new app start up sequence is the following pseudo code in our AppDelegate:</p>

<ol>
  <li>Pull the play count filter setting from NSUserDefaults.</li>
  <li>Create a user data store class instance that will pull user data from NSUserDefaults.</li>
  <li>Create a UsersController and pass in our userStore and playCountFilter.</li>
</ol>

<p>Why not have each controller interact with NSUserDefaults as needed? I consider NSUserDefaults a store for global variables. Doing all global IO in one place (the AppDelegate) is better separation of concerns.</p>

<p>At the end of the day it’s a judgement call, and with an app this size there’s only so much anti-pattern spagettification you can even create. With larger apps, it’s a better idea to keep your controllers as functional (in the functional programming sense) as possible.</p>

<h3 id="moving-data-around">Moving data around</h3>

<p><code class="language-plaintext highlighter-rouge">TCSFavoriteUsersController</code> has a by-the-book table view delegate and datasource implementation. It includes adding, removing, and rearranging elements in one section only.</p>

<p>An instance of <code class="language-plaintext highlighter-rouge">TCSFavoriteUsersController</code> is a spring board for 3 other controllers.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">TCSSettingsViewController</code> - users can change the value of playCountFilter.</li>
  <li><code class="language-plaintext highlighter-rouge">TCSUserNameViewController</code> - used to add a new friend or edit an existing friend.</li>
  <li><code class="language-plaintext highlighter-rouge">TCSWeeklyAlbumChartViewController</code> - used to display charts.</li>
</ul>

<p>We need to keep a connection to the Settings &amp; UserName controllers we create and display because we need to know when they change values. Normally this is accomplished through the delegate pattern. Our parent controller will get a message with the new data and dismiss its child. We’re going to try a different pattern using RAC.</p>

<p>This example is for editing the userName of a friend by tapping the cell during edit mode (this used to be done by tapping the accessory button, but changed before release).</p>

<blockquote>
  <p>(TCSFavoriteUsersViewController.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">tableView</span><span class="p">:(</span><span class="n">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="nv">tableView</span> <span class="nf">didSelectRowAtIndexPath</span><span class="p">:(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span><span class="p">{</span>
  <span class="p">[</span><span class="n">tableView</span> <span class="nf">deselectRowAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span> <span class="nf">animated</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>

 <span class="c1">// Get the user name for the row using a helper function.
</span> <span class="c1">// We could get the whole User object, but in this case 
</span> <span class="c1">// we only need the name.
</span>  <span class="n">NSString</span> <span class="o">*</span><span class="n">userName</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">userNameForIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">];</span>

  <span class="c1">// Selecting the cell has different behavior depending on 
</span>  <span class="c1">// whether or not the controller is in edit mode.
</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="p">.</span><span class="n">editing</span><span class="p">){</span>
  
    <span class="c1">// In non-editing mode, just present a new chart controller.
</span>    <span class="n">TCSWeeklyAlbumChartViewController</span> <span class="o">*</span><span class="n">albumChartController</span> <span class="o">=</span> <span class="p">[[</span><span class="n">TCSWeeklyAlbumChartViewController</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithUserName</span><span class="p">:</span><span class="n">userName</span> <span class="nf">playCountFilter</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">playCountFilter</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">navigationController</span> <span class="nf">pushViewController</span><span class="p">:</span><span class="n">albumChartController</span> <span class="nf">animated</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    
    <span class="n">TCSUserNameViewController</span> <span class="o">*</span><span class="n">userNameController</span> <span class="o">=</span> <span class="p">[[</span><span class="n">TCSUserNameViewController</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithUserName</span><span class="p">:</span><span class="n">userName</span> <span class="nf">headerShowing</span><span class="p">:</span><span class="nb">NO</span><span class="p">];</span>
    <span class="err">@weakify</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
    
    <span class="c1">// The userNameController has a signal (analogous to a protocol) that
</span>    <span class="c1">// sends the User object if it has changed.
</span>    <span class="c1">// We subscribe to it in advance, and write our instructions for
</span>    <span class="c1">// processing changes.
</span>    <span class="p">[[</span><span class="n">userNameController</span> <span class="nf">userSignal</span><span class="p">]</span> <span class="nf">subscribeNext</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">User</span> <span class="o">*</span><span class="n">user</span><span class="p">){</span>
      <span class="err">@strongify</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">;</span>
      
      <span class="c1">// Section 0 is for the primary user.
</span>      <span class="c1">// Section 1 is for friends.
</span>      <span class="c1">// Our userStore class takes care of the actual replacement 
</span>      <span class="c1">// and persistence.
</span>      <span class="k">if</span> <span class="p">(</span><span class="n">indexPath</span><span class="p">.</span><span class="n">section</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">userStore</span> <span class="nf">setUser</span><span class="p">:</span><span class="n">user</span><span class="p">]</span><span class="err">;</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">userStore</span> <span class="nf">replaceFriendAtIndex</span><span class="p">:</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span> <span class="nf">withFriend</span><span class="p">:</span><span class="n">user</span><span class="p">]</span><span class="err">;</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="nf">completed</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
      <span class="c1">// The signal completing tells us that we can remove the user name controller.
</span>      <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">navigationController</span> <span class="nf">popViewControllerAnimated</span><span class="p">:</span><span class="nb">YES</span><span class="p">]</span><span class="err">;</span>
    <span class="p">}];</span>
    
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">navigationController</span> <span class="nf">pushViewController</span><span class="p">:</span><span class="n">userNameController</span> <span class="nf">animated</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The child controller has a signal instead of a protocol method. We place what would be the protocol method’s contents in the signal subscription block.</p>

<p>What do I gain by doing it with RAC? Not much in this particular implementation. I can keep the response behavior localized in the controller definition, and expand it to its own method if it happens in multiple places.  I also could have done some filtering on the sending or receiving side or sent an error signal.</p>

<p>To make this work on the <code class="language-plaintext highlighter-rouge">TCSUserNameController.m</code> side, I first created a public property for the <code class="language-plaintext highlighter-rouge">userSignal</code>. Then, I created a new <code class="language-plaintext highlighter-rouge">RACSubject</code> in the designated <code class="language-plaintext highlighter-rouge">init</code> method of the controller. Remember, an <code class="language-plaintext highlighter-rouge">RACSubject</code> is capable of sending next, complete, or error values whenever we want.</p>

<p>We’ll use a done button or textField’s return button as our confirm button.</p>

<blockquote>
  <p>(TCSUserNameViewController.m)</p>
</blockquote>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="cp">#pragma mark - private
</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">doDone</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">sender</span><span class="p">{</span>
  <span class="n">self</span><span class="p">.</span><span class="n">loading</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
  <span class="p">[[[</span><span class="n">self</span><span class="p">.</span><span class="n">lastFMClient</span> <span class="nf">fetchUserForUserName</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">userNameField</span><span class="p">.</span><span class="n">text</span><span class="p">]</span>
     <span class="nf">deliverOn</span><span class="p">:[</span><span class="n">RACScheduler</span> <span class="nf">mainThreadScheduler</span><span class="p">]]</span>
   <span class="nf">subscribeNext</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">User</span> <span class="o">*</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">userSignal</span> <span class="nf">sendNext</span><span class="p">:</span><span class="n">user</span><span class="p">]</span><span class="err">;</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">userSignal</span> <span class="nf">sendCompleted</span><span class="p">]</span><span class="err">;</span>
  <span class="p">}</span> <span class="nf">error</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">[[[</span><span class="n">UIAlertView</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithTitle</span><span class="p">:</span><span class="s">@"Vinylogue"</span> <span class="nf">message</span><span class="p">:[</span><span class="n">error</span> <span class="nf">localizedDescription</span><span class="p">]</span> <span class="nf">delegate</span><span class="p">:</span><span class="nb">nil</span> <span class="nf">cancelButtonTitle</span><span class="p">:</span><span class="s">@"OK"</span> <span class="nf">otherButtonTitles</span><span class="p">:</span><span class="nb">nil</span><span class="p">]</span> <span class="nf">show</span><span class="p">]</span><span class="err">;</span>
    <span class="n">self</span><span class="p">.</span><span class="n">loading</span> <span class="o">=</span> <span class="nb">NO</span><span class="err">;</span>
  <span class="p">}</span> <span class="nf">completed</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
    <span class="n">self</span><span class="p">.</span><span class="n">loading</span> <span class="o">=</span> <span class="nb">NO</span><span class="err">;</span>
  <span class="p">}];</span>
<span class="p">}</span></code></pre></figure>

<p>I initially implemented this by simply returning whatever userName the user entered in the box without any checking. As an additional feature, I implemented a network call into this step that checks the userName with Last.fm before returning it. The side effect is that the name gets formatted as it was intended.</p>

<h2 id="release"><a href="id:end">Release</a></h2>

<p>We’re skipping a few steps at the end here (testing, analyzing, prepping for the App Store), but this post is long enough as it is.</p>

<h3 id="improvements">Improvements</h3>

<p>There are a few things I’d like to take a look at in future versions.</p>

<h4 id="more-stable-threading">More stable threading</h4>

<p>I’m doing some strange things with threading, including setting controller properties on background threads. Most of the time it seems to work out, but I need to take a step back and map out the flow of property setting and events.</p>

<h4 id="better-cell-image-handling">Better cell image handling</h4>

<p>I covered how I handle cell images above, but my method has some code smell and could probably use another look.</p>

<h4 id="testing">Testing</h4>

<p>At this point in time, I haven’t explored unit testing or UI automation testing at all, and would like to give those a shot with this project.</p>

<h3 id="v11">V1.1</h3>

<p>While the app was processing in the App Store, I worked on several improvement to V1.1. I added friend importing to the Scrobblers controller. I also created an album detail controller which changes background color based on the album image.</p>

<p>I’ll be waiting to hear back from users before implementing any other new features.</p>

<h2 id="final-thoughts">Final thoughts</h2>

<p>Congrats if you made it this far. Although I didn’t exactly hit all my goals for this post, I didn’t think it’d be nearly this long either. I hope this post will add to the discussion about ReactiveCocoa. Ping me on twitter <a href="http://twocentstudios.com">@twocentstudios</a> if you have comments or questions. Or check out the Hacker News <a href="https://news.ycombinator.com/item?id=5488070">thread</a>.</p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">twocentstudios</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li><a href="mailto:chris@twocentstudios.com">chris@twocentstudios.com</a></li>
          
          <li>
            <a href="https://github.com/twocentstudios">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">twocentstudios</span>
            </a>
          </li>
          

          <li>
            <a href="https://hackyderm.io/@twocentstudios">
              <span class="icon">
                <svg viewBox="0 0 24 24">
                  <path fill="#828282" d="M21.327 8.566c0-4.339-2.843-5.61-2.843-5.61-1.433-.658-3.894-.935-6.451-.956h-.063c-2.557.021-5.016.298-6.45.956 0 0-2.843 1.272-2.843 5.61 0 .993-.019 2.181.012 3.441.103 4.243.778 8.425 4.701 9.463 1.809.479 3.362.579 4.612.51 2.268-.126 3.541-.809 3.541-.809l-.075-1.646s-1.621.511-3.441.449c-1.804-.062-3.707-.194-3.999-2.409a4.523 4.523 0 0 1-.04-.621s1.77.433 4.014.536c1.372.063 2.658-.08 3.965-.236 2.506-.299 4.688-1.843 4.962-3.254.434-2.223.398-5.424.398-5.424zm-3.353 5.59h-2.081V9.057c0-1.075-.452-1.62-1.357-1.62-1 0-1.501.647-1.501 1.927v2.791h-2.069V9.364c0-1.28-.501-1.927-1.502-1.927-.905 0-1.357.546-1.357 1.62v5.099H6.026V8.903c0-1.074.273-1.927.823-2.558.566-.631 1.307-.955 2.228-.955 1.065 0 1.872.409 2.405 1.228l.518.869.519-.869c.533-.819 1.34-1.228 2.405-1.228.92 0 1.662.324 2.228.955.549.631.822 1.484.822 2.558v5.253z"/>
                </svg>
              </span>

              <span class="username">twocentstudios</span>
            </a>
          </li>

          
          <li>
            <a href="https://twitter.com/twocentstudios">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">twocentstudios</span>
            </a>
          </li>
          
        </ul>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
